
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Blockæ·±ç©¶ - iOSæ¢¦å·¥å‚</title>
  <meta name="author" content="iCocos">

  
  <meta name="description" content="iCocosåšå®¢">
  <meta name="keywords" content="iCocos, iOSå¼€å‘, åšå®¢, æŠ€æœ¯åˆ†æ, æ–‡ç« , å­¦ä¹ , æ›¹é», æ›¹ç†é¹">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://al1020119.github.io/blog/2015/09/06/blockshen-jiu/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="iOSæ¢¦å·¥å‚" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

<!--<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">iOSæ¢¦å·¥å‚</a></h1>
  
    <h2>iCocosâ€”â€”ä¸æˆ˜èƒœè‡ªå·±ï¼Œä½•ä»¥æ”¹å˜æœªæ¥ï¼</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="al1020119.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">åšæ–‡</a></li>
  <li><a href="/blog/archives">å½’æ¡£</a></li>
  <li><a href="/icocos">iCocos</a></li>
  <li><a href="/about">æ–‡ç« </a></li>
  <li><a href="/other">å…¶ä»–</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Blockæ·±ç©¶</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-06T17:43:24+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:43 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>ç›®å½•</h2>

<ul>
<li><h5>ä»€ä¹ˆæ˜¯blockï¼Ÿ</h5>

<ul>
<li>blockç¼–è¯‘è½¬æ¢ç»“æ„</li>
<li>blockå®é™…ç»“æ„</li>
</ul>
</li>
<li><h5>blockçš„ç±»å‹</h5>

<ul>
<li>NSConcreteGlobalBlockå’ŒNSConcreteStackBlock</li>
<li>NSConcreteMallocBlock</li>
</ul>
</li>
<li><h5>æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“</h5>

<ul>
<li>å±€éƒ¨å˜é‡</li>
<li>å…¨å±€å˜é‡</li>
<li>å±€éƒ¨é™æ€å˜é‡</li>
<li>__blockä¿®é¥°çš„å˜é‡</li>
<li>selféšå¼å¾ªç¯å¼•ç”¨</li>
</ul>
</li>
<li><h5>ä¸åŒç±»å‹blockçš„å¤åˆ¶</h5>

<ul>
<li>æ ˆblock</li>
<li>å †block</li>
<li>å…¨å±€block</li>
</ul>
</li>
<li><h5>blockè¾…åŠ©å‡½æ•°</h5>

<ul>
<li>__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°</li>
<li>å¯¹è±¡çš„è¾…åŠ©å‡½æ•°</li>
</ul>
</li>
<li><h5>ARCä¸­blockçš„å·¥ä½œ</h5>

<ul>
<li>blockè¯•éªŒ</li>
<li>blockä½œä¸ºå‚æ•°ä¼ é€’</li>
<li>blockä½œä¸ºè¿”å›å€¼</li>
<li>blockå±æ€§</li>
</ul>
</li>
</ul>


<!--more-->


<h3>å‚è€ƒåšæ–‡</h3>

<p>æœ€è¿‘çœ‹äº†ä¸€äº›blockçš„èµ„æ–™ï¼Œå¹¶åŠ¨æ‰‹åšäº†ä¸€äº›å®è·µï¼Œæ‘˜å½•å¹¶æ·»åŠ äº†ä¸€äº›ç»“è®ºã€‚</p>

<h3>ä»€ä¹ˆæ˜¯blockï¼Ÿ</h3>

<p>é¦–å…ˆï¼Œçœ‹ä¸€ä¸ªæç®€çš„blockï¼š</p>

<pre><code>    int main(int argc, const char * argv[]) {
        @autoreleasepool {

            ^{ };
        }
        return 0;
    }
</code></pre>

<h5>blockç¼–è¯‘è½¬æ¢ç»“æ„</h5>

<p>å¯¹å…¶æ‰§è¡Œclang -rewrite-objcç¼–è¯‘è½¬æ¢æˆC++å®ç°ï¼Œå¾—åˆ°ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code>    struct __block_impl {
        void *isa;
        int Flags;
        int Reserved;
        void *FuncPtr;
    };

    struct __main_block_impl_0 {
      struct __block_impl impl;
      struct __main_block_desc_0* Desc;
      __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
        impl.isa = &amp;_NSConcreteStackBlock;
        impl.Flags = flags;
        impl.FuncPtr = fp;
        Desc = desc;
      }
    };
    static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
    }

    static struct __main_block_desc_0 {
      size_t reserved;
      size_t Block_size;
    } __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
    int main(int argc, const char * argv[]) {
        /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
            (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA);
        }
        return 0;
    }
</code></pre>

<p>ä¸éš¾çœ‹å‡ºå…¶ä¸­çš„<strong>main_block_impl_0å°±æ˜¯blockçš„ä¸€ä¸ªC++çš„å®ç°(æœ€åé¢çš„_0ä»£è¡¨æ˜¯mainä¸­çš„ç¬¬å‡ ä¸ªblock)ï¼Œä¹Ÿå°±æ˜¯è¯´ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚
å…¶ä¸­</strong>block_implçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code>struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};
</code></pre>

<p>å…¶ç»“æ„ä½“æˆå‘˜å¦‚ä¸‹ï¼š</p>

<ul>
<li>isaï¼ŒæŒ‡å‘æ‰€å±ç±»çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯blockçš„ç±»å‹</li>
<li>flagsï¼Œæ ‡å¿—å˜é‡ï¼Œåœ¨å®ç°blockçš„å†…éƒ¨æ“ä½œæ—¶ä¼šç”¨åˆ°</li>
<li>Reservedï¼Œä¿ç•™å˜é‡</li>
<li>FuncPtrï¼Œblockæ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆ</li>
<li>å¯ä»¥çœ‹å‡ºï¼Œå®ƒåŒ…å«äº†isaæŒ‡é’ˆï¼ˆåŒ…å«isaæŒ‡é’ˆçš„çš†ä¸ºå¯¹è±¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´blockä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡* (runtimeé‡Œé¢ï¼Œå¯¹è±¡å’Œç±»éƒ½æ˜¯ç”¨ç»“æ„ä½“è¡¨ç¤º)ã€‚</li>
</ul>


<p>__main_block_desc_0çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code>    static struct __main_block_desc_0 {
      size_t reserved;
      size_t Block_size;
    } __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
</code></pre>

<p>å…¶ç»“æ„æˆå‘˜å«ä¹‰å¦‚ä¸‹ï¼š</p>

<ul>
<li>reservedï¼šä¿ç•™å­—æ®µ</li>
<li>Block_sizeï¼šblockå¤§å°(sizeof(struct __main_block_impl_0))</li>
<li>ä»¥ä¸Šä»£ç åœ¨å®šä¹‰<strong>main_block_desc_0ç»“æ„ä½“æ—¶ï¼ŒåŒæ—¶åˆ›å»ºäº†</strong>main_block_desc_0_DATAï¼Œå¹¶ç»™å®ƒèµ‹å€¼ï¼Œä»¥ä¾›åœ¨mainå‡½æ•°ä¸­å¯¹__main_block_impl_0è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
</ul>


<p>__main_block_impl_0å®šä¹‰äº†æ˜¾å¼çš„æ„é€ å‡½æ•°ï¼Œå…¶å‡½æ•°ä½“å¦‚ä¸‹ï¼š</p>

<pre><code>  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
</code></pre>

<p>å¯ä»¥çœ‹å‡ºï¼Œ</p>

<ul>
<li><em>_main_block_impl_0çš„isaæŒ‡é’ˆæŒ‡å‘äº†</em>NSConcreteStackBlockï¼Œ</li>
<li>ä»mainå‡½æ•°ä¸­çœ‹ï¼Œ <strong>main_block_impl_0çš„FuncPtræŒ‡å‘äº†å‡½æ•°</strong>main_block_func_0</li>
<li><strong>main_block_impl_0çš„Descä¹ŸæŒ‡å‘äº†å®šä¹‰</strong>main_block_desc_0æ—¶å°±åˆ›å»ºçš„__main_block_desc_0_DATAï¼Œå…¶ä¸­çºªå½•äº†blockç»“æ„ä½“å¤§å°ç­‰ä¿¡æ¯ã€‚</li>
<li>ä»¥ä¸Šå°±æ˜¯æ ¹æ®ç¼–è¯‘è½¬æ¢çš„ç»“æœï¼Œå¯¹ä¸€ä¸ªç®€å•blockçš„è§£æï¼Œåé¢ä¼šå°†blockæ“ä½œä¸åŒç±»å‹çš„å¤–éƒ¨å˜é‡ï¼Œå¯¹blockç»“æ„çš„å½±å“è¿›è¡Œç›¸åº”çš„è¯´æ˜ã€‚</li>
</ul>


<h5>blockå®é™…ç»“æ„</h5>

<p>æ¥ä¸‹æ¥è§‚å¯Ÿä¸‹Block_private.hæ–‡ä»¶ä¸­å¯¹blockçš„ç›¸å…³ç»“æ„ä½“çš„çœŸå®å®šä¹‰ï¼š</p>

<pre><code>/* Revised new layout. */
struct Block_descriptor {
    unsigned long int reserved;
    unsigned long int size;
    void (*copy)(void *dst, void *src);
    void (*dispose)(void *);
};


struct Block_layout {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct Block_descriptor *descriptor;
    /* Imported variables. */
};
</code></pre>

<p>æœ‰äº†ä¸Šæ–‡å¯¹ç¼–è¯‘è½¬æ¢çš„åˆ†æï¼Œè¿™é‡Œåªé’ˆå¯¹ç•¥å¾®ä¸åŒçš„æˆå‘˜è¿›è¡Œåˆ†æï¼š</p>

<p>invokeï¼ŒåŒä¸Šæ–‡çš„FuncPtrï¼Œblockæ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œblockå®šä¹‰æ—¶å†…éƒ¨çš„æ‰§è¡Œä»£ç éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­
Block_descriptorï¼Œblockçš„è¯¦ç»†æè¿°</p>

<ul>
<li>copy/disposeï¼Œè¾…åŠ©æ‹·è´/é”€æ¯å‡½æ•°ï¼Œå¤„ç†blockèŒƒå›´å¤–çš„å˜é‡æ—¶ä½¿ç”¨</li>
<li>æ€»ä½“æ¥è¯´ï¼Œblockå°±æ˜¯ä¸€ä¸ªé‡Œé¢å­˜å‚¨äº†æŒ‡å‘å‡½æ•°ä½“ä¸­åŒ…å«å®šä¹‰blockæ—¶çš„ä»£ç å—çš„å‡½æ•°æŒ‡é’ˆï¼Œä»¥åŠblockå¤–éƒ¨ä¸Šä¸‹æ–‡å˜é‡ç­‰ä¿¡æ¯çš„ç»“æ„ä½“ã€‚</li>
</ul>


<h3>blockçš„ç±»å‹</h3>

<p>blockçš„å¸¸è§ç±»å‹æœ‰3ç§ï¼š</p>

<ul>
<li>_NSConcreteGlobalBlockï¼ˆå…¨å±€ï¼‰</li>
<li>_NSConcreteStackBlockï¼ˆæ ˆï¼‰</li>
<li>_NSConcreteMallocBlockï¼ˆå †ï¼‰</li>
</ul>


<p>é™„ä¸ŠAPUEçš„è¿›ç¨‹è™šæ‹Ÿå†…å­˜æ®µåˆ†å¸ƒå›¾ï¼š</p>

<p><img src="/images/block001.png" title="Caption" ></p>

<p>è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒ</p>

<ul>
<li>å…¶ä¸­å‰2ç§åœ¨Block.hç§å£°æ˜ï¼Œå1ç§åœ¨Block_private.hä¸­å£°æ˜ï¼Œæ‰€ä»¥æœ€å1ç§åŸºæœ¬ä¸ä¼šåœ¨æºç ä¸­å‡ºç°ã€‚</li>
<li>ç”±äºæ— æ³•ç›´æ¥åˆ›å»º_NSConcreteMallocBlockç±»å‹çš„blockï¼Œæ‰€ä»¥è¿™é‡Œåªå¯¹å‰é¢2ç§è¿›è¡Œæ‰‹åŠ¨åˆ›å»ºåˆ†æï¼Œæœ€å1ç§é€šè¿‡æºä»£ç åˆ†æã€‚</li>
</ul>


<h5>NSConcreteGlobalBlockå’ŒNSConcreteStackBlock</h5>

<p>é¦–å…ˆï¼Œæ ¹æ®å‰é¢ä¸¤ç§ç±»å‹ï¼Œç¼–å†™ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code>void (^globalBlock)() = ^{

};

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        void (^stackBlock1)() = ^{

        };
    }
    return 0;
}
</code></pre>

<p>å¯¹å…¶è¿›è¡Œç¼–è¯‘è½¬æ¢åå¾—åˆ°ä»¥ä¸‹ç¼©ç•¥ä»£ç ï¼š</p>

<pre><code>// globalBlock
struct __globalBlock_block_impl_0 {
  struct __block_impl impl;
  struct __globalBlock_block_desc_0* Desc;
  __globalBlock_block_impl_0(void *fp, struct __globalBlock_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteGlobalBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
...

// stackBlock
struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
...
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
        void (*stackBlock)() = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA);
    }
    return 0;
}
</code></pre>

<p>å¯ä»¥çœ‹å‡ºglobalBlockçš„isaæŒ‡å‘äº†<em>NSConcreteGlobalBlockï¼Œå³åœ¨å…¨å±€åŒºåŸŸåˆ›å»ºï¼Œç¼–è¯‘æ—¶å…·ä½“çš„ä»£ç å°±å·²ç»ç¡®å®šåœ¨ä¸Šå›¾ä¸­çš„ä»£ç æ®µä¸­äº†ï¼Œblockå˜é‡å­˜å‚¨åœ¨å…¨å±€æ•°æ®å­˜å‚¨åŒºï¼›stackBlockçš„isaæŒ‡å‘äº†</em>NSConcreteStackBlockï¼Œå³åœ¨æ ˆåŒºåˆ›å»ºã€‚</p>

<h5>NSConcreteMallocBlock</h5>

<ul>
<li><p>æ¥ä¸‹æ¥æ˜¯åœ¨å †ä¸­çš„blockï¼Œå †ä¸­çš„blockæ— æ³•ç›´æ¥åˆ›å»ºï¼Œå…¶éœ€è¦ç”±<em>NSConcreteStackBlockç±»å‹çš„blockæ‹·è´è€Œæ¥(ä¹Ÿå°±æ˜¯è¯´blockéœ€è¦æ‰§è¡Œcopyä¹‹åæ‰èƒ½å­˜æ”¾åˆ°å †ä¸­)ã€‚ç”±äºblockçš„æ‹·è´æœ€ç»ˆéƒ½ä¼šè°ƒç”¨</em>Block_copy_internalå‡½æ•°ï¼Œæ‰€ä»¥è§‚å¯Ÿè¿™ä¸ªå‡½æ•°å°±å¯ä»¥çŸ¥é“å †ä¸­blockæ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„äº†ï¼š</p>

<pre><code>  static void *_Block_copy_internal(const void *arg, const int flags) {
      struct Block_layout *aBlock;
      ...
      aBlock = (struct Block_layout *)arg;
      ...
      // Its a stack block.  Make a copy.
      if (!isGC) {
          // ç”³è¯·blockçš„å †å†…å­˜
          struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
          if (!result) return (void *)0;
          // æ‹·è´æ ˆä¸­blockåˆ°åˆšç”³è¯·çš„å †å†…å­˜ä¸­
          memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
          // reset refcount
          result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
          result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
          // æ”¹å˜isaæŒ‡å‘_NSConcreteMallocBlockï¼Œå³å †blockç±»å‹
          result-&gt;isa = _NSConcreteMallocBlock;
          if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
              //printf("calling block copy helper %p(%p, %p)...\n", aBlock-&gt;descriptor-&gt;copy, result, aBlock);
              (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
          }
          return result;
      }
      else {
          ...
      }
  }
</code></pre>

<p>ä»ä»¥ä¸Šä»£ç ä»¥åŠæ³¨é‡Šå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹å‡ºï¼Œå‡½æ•°é€šè¿‡memmoveå°†æ ˆä¸­çš„blockçš„å†…å®¹æ‹·è´åˆ°äº†å †ä¸­ï¼Œå¹¶ä½¿isaæŒ‡å‘äº†_NSConcreteMallocBlockã€‚
blockä¸»è¦çš„ä¸€äº›å­¦é—®å°±å‡ºåœ¨æ ˆä¸­blockå‘å †ä¸­blockçš„è½¬ç§»è¿‡ç¨‹ä¸­äº†ã€‚</p></li>
</ul>


<p>æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“
æ¥ä¸‹æ¥ä¼šç¼–è¯‘è½¬æ¢æ•æ‰ä¸åŒå˜é‡ç±»å‹çš„blockï¼Œä»¥å¯¹æ¯”å®ƒä»¬çš„åŒºåˆ«ã€‚</p>

<h5>å±€éƒ¨å˜é‡</h5>

<p>å‰ï¼š</p>

<pre><code>- (void)test
{
    int a;
    ^{a;};
}
</code></pre>

<p>åï¼š</p>

<pre><code>struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  int a;
  // a(_a)æ˜¯æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨åˆå§‹åŒ–å½¢å¼ï¼Œç›¸å½“äºa = _aã€‚ä»_I_Person_testçœ‹ï¼Œä¼ å…¥çš„å°±æ˜¯a
  __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int _a, int flags=0) : a(_a) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
  int a = __cself-&gt;a; // bound by copy
a;}

static struct __Person__test_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __Person__test_block_desc_0_DATA = { 0, sizeof(struct __Person__test_block_impl_0)};

static void _I_Person_test(Person * self, SEL _cmd) {
    int a;
    (void (*)())&amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;__Person__test_block_desc_0_DATA, a);
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œblockç›¸å¯¹äºæ–‡ç« å¼€å¤´å¢åŠ äº†ä¸€ä¸ªintç±»å‹çš„æˆå‘˜å˜é‡ï¼Œä»–å°±æ˜¯ç”¨æ¥å­˜å‚¨å¤–éƒ¨å˜é‡açš„ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡æ‹·è´åªæ˜¯ä¸€æ¬¡å€¼ä¼ é€’ã€‚å¹¶ä¸”å½“æˆ‘ä»¬æƒ³åœ¨blockä¸­è¿›è¡Œä»¥ä¸‹æ“ä½œæ—¶ï¼Œå°†ä¼šå‘ç”Ÿé”™è¯¯</p>

<pre><code>^{a = 10;};
</code></pre>

<p>ç¼–è¯‘å™¨ä¼šæç¤º</p>

<p><img src="/images/block002.png" title="Caption" ></p>

<p>é”™è¯¯æç¤º
ã€‚å› ä¸º_I_Person_testå‡½æ•°ä¸­çš„aå’ŒPersontest_block_func_0å‡½æ•°ä¸­çš„aå¹¶æ²¡æœ‰åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸï¼Œæ‰€ä»¥åœ¨blockå¯¹aè¿›è¡Œèµ‹å€¼æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ç»™å‡ºäº†é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ°å€ä¼ é€’æ¥æ¶ˆé™¤ä»¥ä¸Šé”™è¯¯ï¼š</p>

<pre><code>- (void)test
{
    int a = 0;
    // åˆ©ç”¨æŒ‡é’ˆpå­˜å‚¨açš„åœ°å€
    int *p = &amp;a;

    ^{
        // é€šè¿‡açš„åœ°å€è®¾ç½®açš„å€¼
        *p = 10;
    };
}
</code></pre>

<p>ä½†æ˜¯å˜é‡açš„ç”Ÿå‘½å‘¨æœŸæ˜¯å’Œæ–¹æ³•testçš„æ ˆç›¸å…³è”çš„ï¼Œå½“testè¿è¡Œç»“æŸï¼Œæ ˆéšä¹‹é”€æ¯ï¼Œé‚£ä¹ˆå˜é‡aå°±ä¼šè¢«é”€æ¯ï¼Œpä¹Ÿå°±æˆä¸ºäº†é‡æŒ‡é’ˆã€‚å¦‚æœblockæ˜¯ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œè¿™äº›ç±»å‹éƒ½æ˜¯è·¨æ ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å†æ¬¡è°ƒç”¨ä¼šé€ æˆé‡æŒ‡é’ˆé”™è¯¯ã€‚</p>

<h5>å…¨å±€å˜é‡</h5>

<p>å‰ï¼š</p>

<pre><code>// å…¨å±€é™æ€
static int a;
// å…¨å±€
int b;
- (void)test
{

    ^{
        a = 10;
        b = 10;
    };
}
</code></pre>

<p>åï¼š</p>

<pre><code>static int a;
int b;

struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {

        a = 10;
        b = 10;
    }

static struct __Person__test_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __Person__test_block_desc_0_DATA = { 0, sizeof(struct __Person__test_block_impl_0)};

static void _I_Person_test(Person * self, SEL _cmd) {

    (void (*)())&amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;__Person__test_block_desc_0_DATA);
}
</code></pre>

<p>å¯ä»¥çœ‹å‡ºï¼Œå› ä¸ºå…¨å±€å˜é‡éƒ½æ˜¯åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºï¼Œåœ¨ç¨‹åºç»“æŸå‰ä¸ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥blockç›´æ¥è®¿é—®äº†å¯¹åº”çš„å˜é‡ï¼Œè€Œæ²¡æœ‰åœ¨Persontest_block_impl_0ç»“æ„ä½“ä¸­ç»™å˜é‡é¢„ç•™ä½ç½®ã€‚</p>

<h5>å±€éƒ¨é™æ€å˜é‡</h5>

<p>å‰</p>

<pre><code>- (void)test
{
    static int a;
    ^{
        a = 10;
    };
}
</code></pre>

<p>åï¼š</p>

<pre><code>struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  int *a;
  __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int *_a, int flags=0) : a(_a) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
  int *a = __cself-&gt;a; // bound by copy
        // è¿™é‡Œé€šè¿‡å±€éƒ¨é™æ€å˜é‡açš„åœ°å€æ¥å¯¹å…¶è¿›è¡Œä¿®æ”¹
        (*a) = 10;
    }

static struct __Person__test_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __Person__test_block_desc_0_DATA = { 0, sizeof(struct __Person__test_block_impl_0)};

static void _I_Person_test(Person * self, SEL _cmd) {
    static int a;
    // ä¼ å…¥açš„åœ°å€
    (void (*)())&amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;__Person__test_block_desc_0_DATA, &amp;a);
}
</code></pre>

<p>éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯é™æ€å±€éƒ¨å˜é‡æ˜¯å­˜å‚¨åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºåŸŸçš„ï¼Œä¹Ÿå°±æ˜¯å’Œç¨‹åºæ‹¥æœ‰ä¸€æ ·çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œéƒ½èƒ½å¤Ÿä¿è¯blockè®¿é—®åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„å˜é‡ã€‚ä½†æ˜¯å…¶ä½œç”¨èŒƒå›´è¿˜æ˜¯å±€é™äºå®šä¹‰å®ƒçš„å‡½æ•°ä¸­ï¼Œæ‰€ä»¥åªèƒ½åœ¨blocké€šè¿‡é™æ€å±€éƒ¨å˜é‡çš„åœ°å€æ¥è¿›è¡Œè®¿é—®ã€‚
å…³äºå˜é‡çš„å­˜å‚¨æˆ‘åŸæ¥çš„è¿™ç¯‡åšå®¢æœ‰æåŠï¼šcè¯­è¨€è‡†æƒ³&ndash;å…¨å±€&mdash;å±€éƒ¨å˜é‡</p>

<h5>__blockä¿®é¥°çš„å˜é‡</h5>

<p>å‰ï¼š</p>

<pre><code>- (void)test
{
   __block int a;
    ^{
        a = 10;
    };
}
</code></pre>

<p>åï¼š</p>

<pre><code>struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};

struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  __Block_byref_a_0 *a; // by ref
  __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&gt;__forwarding) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
  __Block_byref_a_0 *a = __cself-&gt;a; // bound by ref
        // æ³¨æ„ï¼Œè¿™é‡Œçš„_forwardingç”¨æ¥ä¿è¯æ“ä½œçš„å§‹ç»ˆæ˜¯å †ä¸­çš„æ‹·è´aï¼Œè€Œä¸æ˜¯æ ˆä¸­çš„a
        (a-&gt;__forwarding-&gt;a) = 10;
    }
static void __Person__test_block_copy_0(struct __Person__test_block_impl_0*dst, struct __Person__test_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

static void __Person__test_block_dispose_0(struct __Person__test_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

static struct __Person__test_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __Person__test_block_impl_0*, struct __Person__test_block_impl_0*);
  void (*dispose)(struct __Person__test_block_impl_0*);
} __Person__test_block_desc_0_DATA = { 0, sizeof(struct __Person__test_block_impl_0), __Person__test_block_copy_0, __Person__test_block_dispose_0};

static void _I_Person_test(Person * self, SEL _cmd) {
    // __blockå°†aåŒ…è£…æˆäº†ä¸€ä¸ªå¯¹è±¡
   __attribute__((__blocks__(byref))) __Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&amp;a, 0, sizeof(__Block_byref_a_0)};
;
    (void (*)())&amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;__Person__test_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344);
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹æ¯”ä¸Šé¢çš„ç»“æœï¼Œæ˜æ˜¾å¤šäº†<strong>Block_byref_a_0ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­å«æœ‰isaæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯ç”¨æ¥åŒ…è£…å±€éƒ¨å˜é‡açš„ã€‚å½“blockè¢«copyåˆ°å †ä¸­æ—¶ï¼Œ</strong>Person<strong>test_block_impl_0çš„æ‹·è´è¾…åŠ©å‡½æ•°</strong>Person<strong>test_block_copy_0ä¼šå°†</strong>Block_byref_a_0æ‹·è´è‡³å †ä¸­ï¼Œæ‰€ä»¥å³ä½¿å±€éƒ¨å˜é‡æ‰€åœ¨å †è¢«é”€æ¯ï¼Œblockä¾ç„¶èƒ½å¯¹å †ä¸­çš„å±€éƒ¨å˜é‡è¿›è¡Œæ“ä½œã€‚å…¶ä¸­<strong>Block_byref_a_0æˆå‘˜æŒ‡é’ˆ</strong>forwardingç”¨æ¥æŒ‡å‘å®ƒåœ¨å †ä¸­çš„æ‹·è´ï¼Œå…¶ä¾æ®æºç å¦‚ä¸‹ï¼š</p>

<pre><code>static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) {
    struct Block_byref **destp = (struct Block_byref **)dest;
    struct Block_byref *src = (struct Block_byref *)arg;

    ...
    // å †ä¸­æ‹·è´çš„forwardingæŒ‡å‘å®ƒè‡ªå·±
    copy-&gt;forwarding = copy; // patch heap copy to point to itself (skip write-barrier)
    // æ ˆä¸­çš„forwardingæŒ‡å‘å †ä¸­çš„æ‹·è´
    src-&gt;forwarding = copy;  // patch stack to point to heap copy
    ...
}
</code></pre>

<p>è¿™æ ·åšæ˜¯ä¸ºäº†ä¿è¯æ“ä½œçš„å€¼å§‹ç»ˆæ˜¯å †ä¸­çš„æ‹·è´ï¼Œè€Œä¸æ˜¯æ ˆä¸­çš„å€¼ã€‚ï¼ˆå¤„ç†åœ¨å±€éƒ¨å˜é‡æ‰€åœ¨æ ˆè¿˜æ²¡é”€æ¯ï¼Œå°±è°ƒç”¨blockæ¥æ”¹å˜å±€éƒ¨å˜é‡å€¼çš„æƒ…å†µï¼Œå¦‚æœæ²¡æœ‰__forwardingæŒ‡é’ˆï¼Œåˆ™ä¿®æ”¹æ— æ•ˆï¼‰
è‡³äºblockå¦‚ä½•å®ç°å¯¹å±€éƒ¨å˜é‡çš„æ‹·è´ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚</p>

<h5>selféšå¼å¾ªç¯å¼•ç”¨</h5>

<p>å‰ï¼š</p>

<pre><code>@implementation Person
{
    int _a;
    void (^_block)();
}
- (void)test
{
  void (^_block)() = ^{
        _a = 10;
    };
}

@end
</code></pre>

<p>åï¼š</p>

<pre><code>struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  // å¯ä»¥çœ‹åˆ°ï¼Œblockå¼ºå¼•ç”¨äº†self
  Person *self;
  __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, Person *_self, int flags=0) : self(_self) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
  Person *self = __cself-&gt;self; // bound by copy

        (*(int *)((char *)self + OBJC_IVAR_$_Person$_a)) = 10;
    }
static void __Person__test_block_copy_0(struct __Person__test_block_impl_0*dst, struct __Person__test_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;self, (void*)src-&gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static void __Person__test_block_dispose_0(struct __Person__test_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static struct __Person__test_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __Person__test_block_impl_0*, struct __Person__test_block_impl_0*);
  void (*dispose)(struct __Person__test_block_impl_0*);
} __Person__test_block_desc_0_DATA = { 0, sizeof(struct __Person__test_block_impl_0), __Person__test_block_copy_0, __Person__test_block_dispose_0};

static void _I_Person_test(Person * self, SEL _cmd) {
  void (*_block)() = (void (*)())&amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;__Person__test_block_desc_0_DATA, self, 570425344);
}
</code></pre>

<p>å¦‚æœåœ¨ç¼–è¯‘è½¬æ¢å‰ï¼Œå°†<em>aæ”¹æˆself.aï¼Œèƒ½å¾ˆæ˜æ˜¾åœ°çœ‹å‡ºæ˜¯äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨(selfå¼ºå¼•ç”¨blockï¼Œblockå¼ºå¼•ç”¨self)ã€‚é‚£ä¹ˆä½¿ç”¨</em>aå‘¢ï¼Ÿç»è¿‡ç¼–è¯‘è½¬æ¢åï¼Œä¾ç„¶å¯ä»¥åœ¨<strong>Person</strong>test_block_impl_0çœ‹è§selfçš„èº«å½±ã€‚ä¸”åœ¨å‡½æ•°<em>I_Person_testä¸­ï¼Œä¼ å…¥çš„å‚æ•°ä¹Ÿæ˜¯selfã€‚é€šè¿‡ä»¥ä¸‹è¯­å¥ï¼Œå¯ä»¥çœ‹å‡ºï¼Œä¸ç®¡æ˜¯ç”¨ä»€ä¹ˆå½¢å¼è®¿é—®å®ä¾‹å˜é‡ï¼Œæœ€ç»ˆéƒ½ä¼šè½¬æ¢æˆself+å˜é‡å†…å­˜åç§»çš„å½¢å¼ã€‚æ‰€ä»¥åœ¨ä¸Šé¢ä¾‹å­ä¸­ä½¿ç”¨</em>aä¹Ÿä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚</p>

<pre><code>static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
  Person *self = __cself-&gt;self; // bound by copy
        // selfï¼‹å®ä¾‹å˜é‡açš„åç§»å€¼
        (*(int *)((char *)self + OBJC_IVAR_$_Person$_a)) = 10;
    }
</code></pre>

<h3>ä¸åŒç±»å‹blockçš„å¤åˆ¶</h3>

<p>blockçš„å¤åˆ¶ä»£ç åœ¨_Block_copy_internalå‡½æ•°ä¸­ã€‚</p>

<h5>æ ˆblock</h5>

<p>ä»ä»¥ä¸‹ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ ˆblockçš„å¤åˆ¶ä¸ä»…ä»…å¤åˆ¶äº†å…¶å†…å®¹ï¼Œè¿˜æ·»åŠ äº†ä¸€äº›é¢å¤–çš„ä¸œè¥¿</p>

<pre><code>* 1ã€å¾€flagsä¸­å¹¶å…¥äº†BLOCK_NEEDS_FREEï¼ˆè¿™ä¸ªæ ‡å¿—è¡¨æ˜blockéœ€è¦é‡Šæ”¾ï¼Œåœ¨releaseä»¥åŠå†æ¬¡æ‹·è´æ—¶ä¼šç”¨åˆ°ï¼‰

* 2ã€å¦‚æœæœ‰è¾…åŠ©copyå‡½æ•°ï¼ˆBLOCK_HAS_COPY_DISPOSEï¼‰ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ï¼ˆè¿™ä¸ªè¾…åŠ©copyå‡½æ•°æ˜¯ç”¨æ¥æ‹·è´blockæ•è·çš„å˜é‡çš„ï¼‰

struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);
if (!result) return (void *)0;
  memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first
// reset refcount
result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed
result-&gt;flags |= BLOCK_NEEDS_FREE | 1;
result-&gt;isa = _NSConcreteMallocBlock;
if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
      //printf("calling block copy helper %p(%p, %p)...\n", aBlock-&gt;descriptor-&gt;copy, result, aBlock);
      (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup
  }
  return result;
</code></pre>

<h5>å †block</h5>

<p>ä»ä»¥ä¸‹ä»£ç çœ‹å‡ºï¼Œå¦‚æœblockçš„flagsä¸­æœ‰BLOCK_NEEDS_FREEæ ‡å¿—ï¼ˆblockä»æ ˆä¸­æ‹·è´åˆ°å †æ—¶æ·»åŠ çš„æ ‡å¿—ï¼‰ï¼Œå°±æ‰§è¡Œlatching_incr_intæ“ä½œï¼Œå…¶åŠŸèƒ½å°±æ˜¯è®©blockçš„å¼•ç”¨è®¡æ•°åŠ 1ã€‚æ‰€ä»¥å †ä¸­blockçš„æ‹·è´åªæ˜¯å•çº¯åœ°æ”¹å˜äº†å¼•ç”¨è®¡æ•°</p>

<pre><code>  ...
  if (aBlock-&gt;flags &amp; BLOCK_NEEDS_FREE) {
        // latches on high
        latching_incr_int(&amp;aBlock-&gt;flags);
        return aBlock;
    }
  ...
</code></pre>

<h5>å…¨å±€block</h5>

<p>ä»ä»¥ä¸‹ä»£ç çœ‹å‡ºï¼Œå¯¹äºå…¨å±€blockï¼Œå‡½æ•°æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›äº†ä¼ å…¥çš„block</p>

<pre><code>else if (aBlock-&gt;flags &amp; BLOCK_IS_GLOBAL) {
      return aBlock;
}
</code></pre>

<h3>blockè¾…åŠ©å‡½æ•°</h3>

<ul>
<li>ä¸Šæ–‡æåŠåˆ°äº†blockè¾…åŠ©copyä¸disposeå¤„ç†å‡½æ•°ï¼Œè¿™é‡Œåˆ†æä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å†…éƒ¨å®ç°ã€‚åœ¨æ•* è·å˜é‡ä¸º__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹ï¼Œæˆ–è€…ä¸ºå¯¹è±¡æ—¶ï¼Œblockæ‰ä¼šæœ‰è¿™ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ã€‚</li>
<li>blockæ•æ‰å˜é‡æ‹·è´å‡½æ•°ä¸º<em>Block_object_assignã€‚åœ¨è°ƒç”¨å¤åˆ¶blockçš„å‡½æ•°</em>Block_copy_internalæ—¶ï¼Œä¼šæ ¹æ®blockæœ‰æ— è¾…åŠ©å‡½æ•°æ¥å¯¹æ•æ‰å˜é‡æ‹·è´å‡½æ•°<em>Block_object_assignè¿›è¡Œè°ƒç”¨ã€‚è€Œåœ¨</em>Block_object_assignå‡½æ•°ä¸­ï¼Œä¹Ÿä¼šåˆ¤æ–­æ•æ‰å˜é‡åŒ…è£…è€Œæˆçš„å¯¹è±¡(Block_byrefç»“æ„ä½“)æ˜¯å¦æœ‰è¾…åŠ©å‡½æ•°ï¼Œæ¥è¿›è¡Œè°ƒç”¨ã€‚</li>
</ul>


<h5>__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°</h5>

<p>ç¼–å†™ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code>typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        __block int a;
        Block block = ^ {
            a;
        };
}
</code></pre>

<p>è½¬æ¢æˆC++ä»£ç åï¼š</p>

<pre><code>typedef void(*Block)();
// __block int a
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};

// block
struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __Block_byref_a_0 *a; // by ref
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&gt;__forwarding) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

// blockå‡½æ•°ä½“
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_a_0 *a = __cself-&gt;a; // bound by ref

            (a-&gt;__forwarding-&gt;a);
        }
// è¾…åŠ©copyå‡½æ•°
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

// è¾…åŠ©disposeå‡½æ•°
static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
        // è¿™é‡Œåˆ›å»ºäº†ï¼Œå¹¶å°†açš„flagsè®¾ç½®ä¸º0
        __attribute__((__blocks__(byref))) __Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&amp;a, 0, sizeof(__Block_byref_a_0)};
;
        Block block = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344);
    }
    return 0;
}
</code></pre>

<p>ä»ä¸Šé¢ä»£ç ä¸­ï¼Œè¢«<strong>blockä¿®é¥°çš„aå˜é‡å˜ä¸ºäº†</strong>Block_byref_a_0ç±»å‹ï¼Œæ ¹æ®è¿™ä¸ªæ ¼å¼ï¼Œä»æºç ä¸­æŸ¥çœ‹å¾—åˆ°ç›¸ä¼¼çš„å®šä¹‰ï¼š</p>

<pre><code>struct Block_byref {
    void *isa;
    struct Block_byref *forwarding;
    int flags; /* refcount; */
    int size;
    void (*byref_keep)(struct Block_byref *dst, struct Block_byref *src);
    void (*byref_destroy)(struct Block_byref *);
    /* long shared[0]; */
};

// åšä¸‹å¯¹æ¯”
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};

// flags/_flagsç±»å‹
enum {
        /* See function implementation for a more complete description of these fields and combinations */
        // æ˜¯ä¸€ä¸ªå¯¹è±¡
        BLOCK_FIELD_IS_OBJECT   =  3,  /* id, NSObject, __attribute__((NSObject)), block, ... */
        // æ˜¯ä¸€ä¸ªblock
        BLOCK_FIELD_IS_BLOCK    =  7,  /* a block variable */
        // è¢«__blockä¿®é¥°çš„å˜é‡
        BLOCK_FIELD_IS_BYREF    =  8,  /* the on stack structure holding the __block variable */
        // è¢«__weakä¿®é¥°çš„å˜é‡ï¼Œåªèƒ½è¢«è¾…åŠ©copyå‡½æ•°ä½¿ç”¨
        BLOCK_FIELD_IS_WEAK     = 16,  /* declared __weak, only used in byref copy helpers */
        // blockè¾…åŠ©å‡½æ•°è°ƒç”¨ï¼ˆå‘Šè¯‰å†…éƒ¨å®ç°ä¸è¦è¿›è¡Œretainæˆ–è€…copyï¼‰
        BLOCK_BYREF_CALLER      = 128  /* called from __block (byref) copy/dispose support routines. */
    };
</code></pre>

<p>å¯ä»¥çœ‹å‡ºï¼Œ__blockå°†åŸæ¥çš„åŸºæœ¬ç±»å‹åŒ…è£…æˆäº†å¯¹è±¡ã€‚å› ä¸ºä»¥ä¸Šä¸¤ä¸ªç»“æ„ä½“çš„å‰4ä¸ªæˆå‘˜çš„ç±»å‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå†…å­˜ç©ºé—´æ’åˆ—ä¸€è‡´ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>

<pre><code>// è½¬æ¢æˆC++ä»£ç 
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);}

// _Block_object_assignæºç 
void _Block_object_assign(void *destAddr, const void *object, const int flags) {
...
    else if ((flags &amp; BLOCK_FIELD_IS_BYREF) == BLOCK_FIELD_IS_BYREF)  {
        // copying a __block reference from the stack Block to the heap
        // flags will indicate if it holds a __weak reference and needs a special isa
        _Block_byref_assign_copy(destAddr, object, flags);
    }
...
}

// _Block_byref_assign_copyæºç 
static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) {
    // è¿™é‡Œå› ä¸ºå‰é¢4ä¸ªæˆå‘˜çš„å†…å­˜åˆ†å¸ƒä¸€æ ·ï¼Œæ‰€ä»¥ç›´æ¥è½¬æ¢åï¼Œä½¿ç”¨Block_byrefçš„æˆå‘˜å˜é‡åï¼Œèƒ½è®¿é—®åˆ°__Block_byref_a_0çš„å‰é¢4ä¸ªæˆå‘˜
    struct Block_byref **destp = (struct Block_byref **)dest;
    struct Block_byref *src = (struct Block_byref *)arg;
...
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_REFCOUNT_MASK) == 0) {
        // ä»mainå‡½æ•°å¯¹__Block_byref_a_0çš„åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ—¶å°†flagsèµ‹å€¼ä¸º0
        // è¿™é‡Œè¡¨ç¤ºç¬¬ä¸€æ¬¡æ‹·è´ï¼Œä¼šè¿›è¡Œå¤åˆ¶æ“ä½œï¼Œå¹¶ä¿®æ”¹åŸæ¥flagsçš„å€¼
        // static int _Byref_flag_initial_value = BLOCK_NEEDS_FREE | 2;
        // å¯ä»¥çœ‹å‡ºï¼Œå¤åˆ¶åï¼Œä¼šå¹¶å…¥BLOCK_NEEDS_FREEï¼Œåé¢çš„2æ˜¯blockçš„åˆå§‹å¼•ç”¨è®¡æ•°
        ...
        copy-&gt;flags = src-&gt;flags | _Byref_flag_initial_value;
        ...
    }
    // å·²ç»æ‹·è´åˆ°å †äº†ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°
    else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_NEEDS_FREE) == BLOCK_NEEDS_FREE) {
        latching_incr_int(&amp;src-&gt;forwarding-&gt;flags);
    }
    // æ™®é€šçš„èµ‹å€¼ï¼Œé‡Œé¢æœ€åº•å±‚å°±*destptr = value;è¿™å¥è¡¨è¾¾å¼
    _Block_assign(src-&gt;forwarding, (void **)destp);
}
</code></pre>

<p>ä¸»è¦æ“ä½œéƒ½åœ¨ä»£ç æ³¨é‡Šä¸­äº†ï¼Œæ€»ä½“æ¥è¯´ï¼Œ__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹ä¼šè¢«åŒ…è£…ä¸ºå¯¹è±¡ï¼Œå¹¶ä¸”åªåœ¨æœ€åˆblockæ‹·è´æ—¶å¤åˆ¶ä¸€æ¬¡ï¼Œåé¢çš„æ‹·è´åªä¼šå¢åŠ è¿™ä¸ªæ•è·å˜é‡çš„å¼•ç”¨è®¡æ•°ã€‚</p>

<h5>å¯¹è±¡çš„è¾…åŠ©å‡½æ•°</h5>

<p>æ²¡æœ‰__blockä¿®é¥°</p>

<pre><code>typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}
</code></pre>

<p>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰__blockä¿®é¥°æ—¶ï¼Œå¯¹è±¡ç¼–è¯‘è½¬æ¢çš„ç»“æœå¦‚ä¸‹ï¼Œåˆ é™¤äº†ä¸€äº›å˜åŒ–ä¸å¤§çš„ä»£ç ï¼š</p>

<pre><code>static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  NSObject *a = __cself-&gt;a; // bound by copy
            a;
        }
static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0),
</code></pre>

<p>å¯¹è±¡åœ¨æ²¡æœ‰<strong>blockä¿®é¥°æ—¶ï¼Œå¹¶æ²¡æœ‰äº§ç”Ÿ</strong>Block_byref_a_0ç»“æ„ä½“ï¼Œåªæ˜¯å°†æ ‡å¿—ä½ä¿®æ”¹ä¸ºBLOCK_FIELD_IS_OBJECTã€‚è€Œåœ¨_Block_object_assignä¸­å¯¹åº”çš„åˆ¤æ–­åˆ†æ”¯ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code>else if ((flags &amp; BLOCK_FIELD_IS_OBJECT) == BLOCK_FIELD_IS_OBJECT) {
    _Block_retain_object(object);
    _Block_assign((void *)object, destAddr);
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œblockå¤åˆ¶æ—¶ï¼Œä¼šretainæ•æ‰å¯¹è±¡ï¼Œä»¥å¢åŠ å…¶å¼•ç”¨è®¡æ•°ã€‚</p>

<p>æœ‰__blockä¿®é¥°</p>

<pre><code>typedef void(^Block)();
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        __block NSObject *a = [[NSObject alloc] init];
        Block block = ^ {
            a;
        };
    }
    return 0;
}
</code></pre>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘è½¬æ¢çš„éƒ¨åˆ†ç»“æœå¦‚ä¸‹ï¼š</p>

<pre><code>struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 void (*__Block_byref_id_object_copy)(void*, void*);
 void (*__Block_byref_id_object_dispose)(void*);
 NSObject *a;
};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;
attribute__((__blocks__(byref))) __Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&amp;a, 33554432, sizeof(__Block_byref_a_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131,....};
Block block = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, 570425344);
}

// ä»¥ä¸‹çš„40è¡¨ç¤º__Block_byref_a_0å¯¹è±¡açš„ä½ç§»ï¼ˆ4ä¸ªæŒ‡é’ˆ(32å­—èŠ‚)ï¼‹2ä¸ªintå˜é‡(8å­—èŠ‚)ï¼40å­—èŠ‚ï¼‰
    static void __Block_byref_id_object_copy_131(void *dst, void *src) {
     _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);
    }
    static void __Block_byref_id_object_dispose_131(void *src) {
     _Block_object_dispose(*(void * *) ((char*)src + 40), 131);
    }
</code></pre>

<ol>
<li><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºå¯¹è±¡ï¼Œ<strong>Block_byref_a_0å¦å¤–å¢åŠ äº†ä¸¤ä¸ªè¾…åŠ©å‡½æ•°</strong>Block_byref_id_object_copyã€__Block_byref_id_object_dispose,ä»¥å®ç°å¯¹å¯¹è±¡</p></li>
<li><p>å†…å­˜çš„ç®¡ç†ã€‚å…¶ä¸­ä¸¤è€…çš„æœ€åä¸€ä¸ªå‚æ•°131è¡¨ç¤ºBLOCK_BYREF_CALLER|BLOCK_FIELD_IS_OBJECTï¼ŒBLOCK_BYREF_CALLERè¡¨ç¤ºåœ¨å†…éƒ¨å®ç°ä¸­ä¸å¯¹aå¯¹è±¡è¿›è¡Œretainæˆ–copyï¼›ä»¥ä¸‹ä¸ºç›¸å…³æºç </p></li>
</ol>


<hr />

<pre><code>if ((flags &amp; BLOCK_BYREF_CALLER) == BLOCK_BYREF_CALLER) {
    ...
    else {
        // do *not* retain or *copy* __block variables whatever they are
        _Block_assign((void *)object, destAddr);
    }
}
</code></pre>

<p>_Block_byref_assign_copyå‡½æ•°çš„ä»¥ä¸‹ä»£ç ä¼šå¯¹ä¸Šé¢çš„è¾…åŠ©å‡½æ•°ï¼ˆ__Block_byref_id_object_copy_131ï¼‰è¿›è¡Œè°ƒç”¨ï¼›570425344è¡¨ç¤ºBLOCK_HAS_COPY_DISPOSE|BLOCK_HAS_DESCRIPTORï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸‹ç›¸å…³æºç ï¼š</p>

<pre><code>if (src-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) {
    // Trust copy helper to copy everything of interest
    // If more than one field shows up in a byref block this is wrong XXX
    copy-&gt;byref_keep = src-&gt;byref_keep;
    copy-&gt;byref_destroy = src-&gt;byref_destroy;
    (*src-&gt;byref_keep)(copy, src);
}
</code></pre>

<h3>ARCä¸­blockçš„å·¥ä½œ</h3>

<p><img src="/images/block003.png" title="Caption" ></p>

<p>è‹¹æœè¯´æ˜</p>

<p>è‹¹æœæ–‡æ¡£æåŠï¼Œåœ¨ARCæ¨¡å¼ä¸‹ï¼Œåœ¨æ ˆé—´ä¼ é€’blockæ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨copyæ ˆä¸­çš„blockï¼Œå³å¯è®©blockæ­£å¸¸å·¥ä½œã€‚ä¸»è¦åŸå› æ˜¯ARCå¯¹æ ˆä¸­çš„blockè‡ªåŠ¨æ‰§è¡Œäº†copyï¼Œå°†<em>NSConcreteStackBlockç±»å‹çš„blockè½¬æ¢æˆäº†</em>NSConcreteMallocBlockçš„blockã€‚</p>

<h5>blockè¯•éªŒ</h5>

<p>ä¸‹é¢å¯¹blockåšç‚¹å®éªŒï¼š</p>

<p>int main(int argc, const char * argv[]) {
    @autoreleasepool {
        int i = 10;
        void (^block)() = ^{i;};</p>

<pre><code>    __weak void (^weakBlock)() = ^{i;};

    void (^stackBlock)() = ^{};

    // ARCæƒ…å†µä¸‹

    // åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåœ¨æ ˆä¸­
    // &lt;__NSStackBlock__: 0x7fff5fbff730&gt;
    NSLog(@"%@", ^{i;});

    // å› ä¸ºstackBlockä¸ºstrongç±»å‹ï¼Œä¸”æ•è·äº†å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥èµ‹å€¼æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œäº†copy
    // &lt;__NSMallocBlock__: 0x100206920&gt;
    NSLog(@"%@", block);

    // å¦‚æœæ˜¯weakç±»å‹çš„blockï¼Œä¾ç„¶ä¸ä¼šè‡ªåŠ¨è¿›è¡Œcopy
    // &lt;__NSStackBlock__: 0x7fff5fbff728&gt;
    NSLog(@"%@", weakBlock);

    // å¦‚æœblockæ˜¯strongç±»å‹ï¼Œå¹¶ä¸”æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šè½¬æ¢æˆ__NSGlobalBlock__
    // &lt;__NSGlobalBlock__: 0x100001110&gt;
    NSLog(@"%@", stackBlock);

    // åœ¨éARCæƒ…å†µä¸‹ï¼Œäº§ç”Ÿä»¥ä¸‹è¾“å‡º
    // &lt;__NSStackBlock__: 0x7fff5fbff6d0&gt;
    // &lt;__NSStackBlock__: 0x7fff5fbff730&gt;
    // &lt;__NSStackBlock__: 0x7fff5fbff700&gt;
    // &lt;__NSGlobalBlock__: 0x1000010d0&gt;
}
return 0;
</code></pre>

<p>}</p>

<p>å¯ä»¥çœ‹å‡ºï¼ŒARCå¯¹ç±»å‹ä¸ºstrongä¸”æ•è·äº†å¤–éƒ¨å˜é‡çš„blockè¿›è¡Œäº†copyã€‚å¹¶ä¸”å½“blockç±»å‹ä¸ºstrongï¼Œä½†æ˜¯åˆ›å»ºæ—¶æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œblockæœ€ç»ˆä¼šå˜æˆ<strong>NSGlobalBlock</strong>ç±»å‹ï¼ˆè¿™é‡Œå¯èƒ½å› ä¸ºblockä¸­çš„ä»£ç æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨æ ˆä¸­å¼€è¾Ÿå˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œè¿™ä¸ªblockçš„æ‰€æœ‰å†…å®¹å·²ç»åœ¨ä»£ç æ®µä¸­ç”Ÿæˆäº†ï¼Œæ‰€ä»¥å°±æŠŠblockçš„ç±»å‹è½¬æ¢ä¸ºå…¨å±€ç±»å‹ï¼‰</p>

<h5>blockä½œä¸ºå‚æ•°ä¼ é€’</h5>

<p>å†æ¥çœ‹ä¸‹ä½¿ç”¨åœ¨æ ˆä¸­çš„blockéœ€è¦æ³¨æ„çš„æƒ…å†µï¼š</p>

<pre><code>NSMutableArray *arrayM;
void myBlock()
{
    int a = 5;
    Block block = ^ {
        NSLog(@"%d", a);
    };

    [arrayM addObject:block];
    NSLog(@"%@", block);
}

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        arrayM = @[].mutableCopy;

        myBlock();

        Block block = [arrayM firstObject];
        // éARCè¿™é‡Œå´©æºƒ
        block();
 }

// ARCæƒ…å†µä¸‹è¾“å‡º
// &lt;__NSMallocBlock__: 0x100214480&gt;

// éARCæƒ…å†µä¸‹è¾“å‡º
// &lt;__NSStackBlock__: 0x7fff5fbff738&gt;
// å´©æºƒï¼Œé‡æŒ‡é’ˆé”™è¯¯
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒARCæƒ…å†µä¸‹å› ä¸ºè‡ªåŠ¨æ‰§è¡Œäº†copyï¼Œæ‰€ä»¥è¿”å›ç±»å‹ä¸º<strong>NSMallocBlock</strong>ï¼Œåœ¨å‡½æ•°ç»“æŸåä¾ç„¶å¯ä»¥è®¿é—®ï¼›è€ŒéARCæƒ…å†µä¸‹ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨[block copy]æ¥å°†blockæ‹·è´åˆ°å †ä¸­ï¼Œå¦åˆ™å› ä¸ºæ ˆä¸­çš„blockç”Ÿå‘½å‘¨æœŸå’Œå‡½æ•°ä¸­çš„æ ˆç”Ÿå‘½å‘¨æœŸå…³è”ï¼Œå½“å‡½æ•°é€€å‡ºåï¼Œç›¸åº”çš„å †è¢«é”€æ¯ï¼Œblockä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚
å¦‚æœæŠŠblockçš„ä»¥ä¸‹ä»£ç åˆ é™¤ï¼š</p>

<pre><code>NSLog(@"%d", a);
é‚£ä¹ˆblockå°±ä¼šå˜æˆå…¨å±€ç±»å‹ï¼Œåœ¨mainä¸­è®¿é—®ä¹Ÿä¸ä¼šå‡ºå´©æºƒã€‚
</code></pre>

<h5>blockä½œä¸ºè¿”å›å€¼</h5>

<pre><code>åœ¨éARCæƒ…å†µä¸‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯blockï¼Œåˆ™ä¸€èˆ¬è¿™æ ·æ“ä½œï¼š

return [[block copy] autorelease];
</code></pre>

<p>å¯¹äºå¤–éƒ¨è¦ä½¿ç”¨çš„blockï¼Œæ›´è¶‹å‘äºæŠŠå®ƒæ‹·è´åˆ°å †ä¸­ï¼Œä½¿å…¶è„±ç¦»æ ˆç”Ÿå‘½å‘¨æœŸçš„çº¦æŸã€‚</p>

<h5>blockå±æ€§</h5>

<p>è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹å…³äºblockç±»å‹çš„ARCå±æ€§ã€‚ä¸Šæ–‡ä¹Ÿè¯´æ˜äº†ï¼ŒARCä¼šè‡ªåŠ¨å¸®strongç±»å‹ä¸”æ•è·å¤–éƒ¨å˜é‡çš„blockè¿›è¡Œcopyï¼Œæ‰€ä»¥åœ¨å®šä¹‰blockç±»å‹çš„å±æ€§æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨strongï¼Œä¸ä¸€å®šä½¿ç”¨copyã€‚ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code>/** å‡å¦‚æœ‰æ ˆblockèµ‹ç»™ä»¥ä¸‹ä¸¤ä¸ªå±æ€§ **/

// è¿™é‡Œå› ä¸ºARCï¼Œå½“æ ˆblockä¸­ä¼šæ•è·å¤–éƒ¨å˜é‡æ—¶ï¼Œè¿™ä¸ªblockä¼šè¢«copyè¿›å †ä¸­
// å¦‚æœæ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œè¿™ä¸ªblockä¼šå˜ä¸ºå…¨å±€ç±»å‹
// ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå®ƒéƒ½è„±ç¦»äº†æ ˆç”Ÿå‘½å‘¨æœŸçš„çº¦æŸ

@property (strong, nonatomic) Block *strongBlock;

// è¿™é‡Œéƒ½ä¼šè¢«copyè¿›å †ä¸­
@property (copy, nonatomic) Block *copyBlock;
</code></pre>

<p>å‚è€ƒåšæ–‡
è°ˆObjective-C Blockçš„å®ç°(<a href="http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/">http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/</a>)
iOSä¸­blockå®ç°çš„æ¢ç©¶(<a href="http://blog.csdn.net/jasonblog/article/details/7756763">http://blog.csdn.net/jasonblog/article/details/7756763</a>)
A look inside blocks: Episode 3
runtime.c
Block_private.h</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">iCocos</span></span>

      




<time class='entry-date' datetime='2015-09-06T17:43:24+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:43 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/low-level/'>low-level</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/25/wang-shang-qing-qiu-feng-(feng-)zhuang/" title="Previous Post: ç½‘ç»œè¯·æ±‚ç–¯ï¼ˆå°ï¼‰è£…">&laquo; ç½‘ç»œè¯·æ±‚ç–¯ï¼ˆå°ï¼‰è£…</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/09/13/you-xiu-cheng-xu-yuan-shi-zen-yao-xie-zhu-shi-de/" title="Next Post: å¤Ÿé€¼æ ¼çš„æ³¨é‡Šä¹ æƒ¯">å¤Ÿé€¼æ ¼çš„æ³¨é‡Šä¹ æƒ¯ &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
    <h1>æ–‡ç« åˆ†ç±»</h1>
    <ul id="categories">
        <li class='category'><a href='/blog/categories/apples/'>apples (2)</a></li>
<li class='category'><a href='/blog/categories/audio-video/'>audio-video (1)</a></li>
<li class='category'><a href='/blog/categories/developer/'>developer (15)</a></li>
<li class='category'><a href='/blog/categories/foundation/'>foundation (32)</a></li>
<li class='category'><a href='/blog/categories/full/'>full (13)</a></li>
<li class='category'><a href='/blog/categories/low-level/'>low-level (4)</a></li>
<li class='category'><a href='/blog/categories/news/'>news (4)</a></li>
<li class='category'><a href='/blog/categories/others/'>others (1)</a></li>
<li class='category'><a href='/blog/categories/performance/'>performance (12)</a></li>
<li class='category'><a href='/blog/categories/reverse/'>reverse (25)</a></li>
<li class='category'><a href='/blog/categories/senior/'>senior (38)</a></li>
<li class='category'><a href='/blog/categories/stack/'>stack (13)</a></li>
<li class='category'><a href='/blog/categories/summarize/'>summarize (5)</a></li>
<li class='category'><a href='/blog/categories/tools/'>tools (5)</a></li>

    </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/07/26/chongzhengzhidao/">é‡æ•´ä¹‹é“ï¼ˆé¢è¯•+æŠ€æœ¯+åº•å±‚+é«˜çº§ï¼‰</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/10/duoxianc/">å¤šçº¿ç¨‹ä¹‹è‘µèŠ±å®å…¸</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/zsqlfmdbcoredata/">CoreData ğŸ˜˜ SQLite ğŸ˜ FMDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/xsqlyucoredata/">CoreData å¤§æˆ˜ SQLite</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/ycoredatayurealm/">Realm çˆ†èŠ CoreData</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/al1020119">@al1020119</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'al1020119',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
<h1>æ‰«ä¸€æ‰«<abbr title="The word 'æ‰«ä¸€æ‰«' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'æ‰«ä¸€æ‰«', not for image.">&trade;</abbr></h1>
<a href="http://al1020119.github.io/blog/2015/09/06/blockshen-jiu/"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=165B94&chl=http://al1020119.github.io/blog/2015/09/06/blockshen-jiu/" alt="post-qrcode"></a></section>
<section>
    <h1>è®¿å®¢ç»Ÿè®¡</h1>
    <br/>
    <a href="http://s07.flagcounter.com/more/2SH"><img src="http://s07.flagcounter.com/count/2SH/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_1/flags_0/" alt="Flag Counter" border="0"></a>
</section><section>
    <h1>æ–°æµªå¾®åš</h1>
    <ul id="weibo">
        <li>
            
            <!-- åœ¨æ­¤æ’å…¥è·å¾—çš„å¾®åšç§€ä»£ç  -->
            <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=3288975567&verifier=20ffcedd&dpc=1"></iframe>
            
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - iCocos -
<span class="credit">welcome to <a href="http://al1020119.github.io">æ›¹#é»</a></span>
</p>

</footer>
  






<!--
-->



</body>
</html>
