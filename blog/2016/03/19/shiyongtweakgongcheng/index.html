
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>使用Tweak工程 - iOS梦工厂</title>
  <meta name="author" content="iCocos">

  
  <meta name="description" content="iCocos博客">
  <meta name="keywords" content="iCocos, iOS开发, 博客, 技术分析, 文章, 学习, 曹黎, 曹理鹏">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://al1020119.github.io/blog/2016/03/19/shiyongtweakgongcheng/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="iOS梦工厂" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

<!--<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">iOS梦工厂</a></h1>
  
    <h2>iCocos——不战胜自己，何以改变未来！</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="al1020119.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">博文</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/icocos">iCocos</a></li>
  <li><a href="/about">文章</a></li>
  <li><a href="/other">其他</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">使用Tweak工程</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-19T13:32:08+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>iOS逆向 - 使用Tweak工程</p>

<p>创建第一个Tweak工程
1、创建工程</p>

<p>在目录下面启动NIC /opt/theos/bin/nic.pl ,可以看到有好多个模板可以选择。 1、4、6、8、9 是Theos自带的模板,其他的是 <a href="https://github.com/DHowett/theos-nic-templates">https://github.com/DHowett/theos-nic-templates</a> 下载的。 这里主要学习tweak的用法，选择9</p>

<pre><code>  NIC 2.0 - New Instance Creator
------------------------------
  [1.] iphone/application
  [2.] iphone/cydget
  [3.] iphone/framework
  [4.] iphone/library
  [5.] iphone/notification_center_widget
  [6.] iphone/preference_bundle
  [7.] iphone/sbsettingstoggle
  [8.] iphone/tool
  [9.] iphone/tweak
  [10.] iphone/xpc_service
Choose a Template (required):
</code></pre>

<!--more-->


<p>输入工程的名字</p>

<pre><code>Project Name (required): reverseDemo
</code></pre>

<p>输入deb包的名字，相当于App的bundle id</p>

<pre><code>Package Name [com.yourcompany.reversedemo]: com.liuchendi.iOSReverse
</code></pre>

<p>输入tweak作者的名字</p>

<pre><code>Author/Maintainer Name [lovelydd]: liuchendi
</code></pre>

<p>输入MobileSubstrate Bundle filter，就是设置tweak作用对象的bundle identifier。就像上一节用Reveal查看别人的App一样，需要知道作用的对象是谁</p>

<pre><code>[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.apple.springboard
</code></pre>

<p>安装完成后需要重启的应用，已进程名表示</p>

<pre><code>[iphone/tweak] List of applications to terminate upon installation (space-separated, '-' for none) [SpringBoard]: SpringBoard
</code></pre>

<p>一个Tweak工程就创建完成了
2、定制工程文件</p>

<p>查看工程里面的文件目录</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ ls -l
total 40
-rw-r--r--  1 liuchendi  staff   182 12 17 17:30 Makefile
-rw-r--r--  1 liuchendi  staff  1045 12 17 17:30 Tweak.xm
-rw-r--r--  1 liuchendi  staff   222 12 17 17:30 control
-rw-r--r--  1 liuchendi  staff    57 12 17 17:30 reverseDemo.plist
lrwxr-xr-x  1 liuchendi  staff    10 12 17 17:30 theos -&gt; /opt/theos
</code></pre>

<p>Makefile：指定工程用到的文件、框架、库等信息，整个过程自动化。</p>

<p>// 固定写法
    include theos/makefiles/common.mk</p>

<pre><code>// tweak名字,就是工程的名字
TWEAK_NAME = reverseDemo

//tweak包含的源文件(不包括头文件),多个文件以空格分隔
reverseDemo_FILES = Tweak.xm

// 根据Theos工程的不同类型，指定不同的.mk文件。
// 逆向初级阶段一般是Application、 Tweak 、Tool三种类型的程序
// 分别对应的.mk文件是 application.mk 、tweak.mk 、tool.mk
include $(THEOS_MAKE_PATH)/tweak.mk

// 安装完成后,杀掉SpringBoard进程,好让CydiaSubstrate在进程启动时加载对应的dylib
after-install::
  install.exec "killall -9 SpringBoard"
</code></pre>

<p>其他功能：</p>

<pre><code>// 指定处理器架构，arm64架构不兼容armv7/armv7s架构,必须适配arm64的dylib
ARCHS = armv7 arm64

//指定SDK版本
TARGET = iphone:8.1:8.0     // 8.1是指定采用的SDK版本，8.0是可以部署安装的版本
TARGET = iphone:latest:8.0 // Xcode附带的最新版本SDK

//导入framework
reverseDemo_FRAMEWORKS = UIKit CoreTelephony

//导入私有framework
reverseDemo_PRIVATE_FRAMEWORK = AppSupport ChatKit

//链接Mach-O对象(Mach-O object)
// -lx 代表链接libx.a 或者libx.dylib
reverseDemo_LDFLAGS = -lx
</code></pre>

<p>Tweak.xm</p>

<p>默认生成的源文件，x表示支持Logos语法。</p>

<pre><code>/* How to Hook with Logos
Hooks are written with syntax similar to that of an Objective-C @implementation.
You don't need to #include &lt;substrate.h&gt;, it will be done automatically, as will
the generation of a class list and an automatic constructor.

%hook ClassName

// Hooking a class method
+ (id)sharedInstance {
  return %orig;
}

// Hooking an instance method with an argument.
- (void)messageName:(int)argument {
  %log; // Write a message about this call, including its class, name and arguments, to the system log.

  %orig; // Call through to the original function with its original arguments.
  %orig(nil); // Call through to the original function with a custom argument.

  // If you use %orig(), you MUST supply all arguments (except for self and _cmd, the automatically generated ones.)
}

// Hooking an instance method with no arguments.
- (id)noArguments {
  %log;
  id awesome = %orig;
  [awesome doSomethingElse];

  return awesome;
}

// Always make sure you clean up after yourself; Not doing so could have grave consequences!
%end
*/
</code></pre>

<p>主要包括几个命令:</p>

<pre><code>%hook : 指定需要hook的class，必须以%end结尾

%log : 在 %hook 函数内部使用，将函数的类名、参数等信息输出，还能够在结尾输出自定义格式信息

%orig : 执行被hook住的源代码，更改原始函数的参数

%group :将 %hook 分组，以%end结尾。便于代码管理及按条件初始化，不属于自定义的group都会隐式归类到%group_ungrouped中。 必须配合下面的 %init 命令才能生效

%init : 初始化某个group，必须在 hook 或 %ctor 内调用。如果带参数，则初始化指定的group。不带参数则初始化_ungrouped。 只有调用了 %init ，group才能生效

%ctor : 一个构造器，完成初始化工作。如果不显示定义，Theos自动生成一个 %ctor 。并在其中调用%init(_ungrouped), %ctor 不需要%end结尾

%new : 给一个现有的class添加新函数,功能与class_addMethod相同

%c : 等同于 objc_getClass 或者 NSClassFromString , 动态获取一个类的定义,在 %hook 或 %ctor 内使用

control
</code></pre>

<p>control记录了deb包管理系统所需的基本信息, 会被打包进deb里。其内容如下:</p>

<pre><code>Package: com.liuchendi.iOSReverse
Name: reverseDemo
Depends: mobilesubstrate    //依赖条件
Version: 0.0.1
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak!
Maintainer: liuchendi   //deb包的维护人
Author: liuchendi       //tweak作者
Section: Tweaks         //所属程序类别
</code></pre>

<p>更全面的介绍在 这里</p>

<pre><code>reverseDemo.plist
</code></pre>

<p>记录一些配置信息，描述tweak的作用范围。其实就是一个字典， Filter 为外键，里面包含有 :</p>

<pre><code>Bundles : tweak作用对象, 也是app的bundle id
Class : tweak作用的若干类
Executables : 指定若干可执行文件
</code></pre>

<p>注意: 当Filter下有不同的类array时候，需要添加Mode: Any键值对
3、编译 + 打包 + 安装
编译:make</p>

<p>执行make,可能出现的错误</p>

<pre><code>Please run `/Users/liuchendi/Desktop/逆向/Demo/reversedemo/theos/bin/bootstrap.sh substrate` manually, with privileges.
make: *** [before-all] Error 1
</code></pre>

<p>将iOS上的 /Library/Frameworks/CydiaSubstrate.framework/ CydiaSubstrate 拷贝到OSX中，将其重命名为libsubstrate.dylib后放到“/opt/theos/lib/libsubstrate. dylib”中</p>

<pre><code>/bin/sh: ldid: command not found
</code></pre>

<p>重新去 <a href="http://joedj.net/ldid">http://joedj.net/ldid</a> 下载ldid，放在/opt/theos/bin/下面,然后赋予可执行权限 sudo chmod 777</p>

<p>成功后的显示,完成了预处理，编译，签名等一系列工作</p>

<pre><code>Making all for tweak reverseDemo...
Preprocessing Tweak.xm...
Compiling Tweak.xm...
Linking tweak reverseDemo...
Stripping reverseDemo...
Signing reverseDemo...
</code></pre>

<p>发现多了一个obj文件夹</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ ls -al
total 40
drwxr-xr-x  9 liuchendi  staff   306 12 17 23:20 .
drwxr-xr-x  4 liuchendi  staff   136 12 17 17:31 ..
drwxr-xr-x  4 liuchendi  staff   136 12 17 23:15 .theos
-rw-r--r--  1 liuchendi  staff   182 12 17 17:30 Makefile
-rw-r--r--  1 liuchendi  staff  1045 12 17 17:30 Tweak.xm
-rw-r--r--  1 liuchendi  staff   222 12 17 17:30 control
drwxr-xr-x  5 liuchendi  staff   170 12 17 23:20 obj
-rw-r--r--  1 liuchendi  staff    57 12 17 17:30 reverseDemo.plist
lrwxr-xr-x  1 liuchendi  staff    10 12 17 17:30 theos -&gt; /opt/theos
</code></pre>

<p>打包 make package</p>

<p>出现的错误</p>

<pre><code>make[2]: Nothing to be done for `internal-library-compile'.
Making stage for tweak reverseDemo...
make: *** [internal-package] Error 255
</code></pre>

<p>下载dm.pl文件 <a href="https://raw.githubusercontent.com/DHowett/dm.pl/master/dm.pl">https://raw.githubusercontent.com/DHowett/dm.pl/master/dm.pl</a> ,然后重命名为dpkg-deb.pl,放到/opt/theos/bin/目录下面。 我把pl后缀名字隐藏了</p>

<p>成功执行后的显示,生成一个*.deb的包</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ make package
Making all for tweak reverseDemo...
Preprocessing Tweak.xm...
Compiling Tweak.xm...
Linking tweak reverseDemo...
Stripping reverseDemo...
Signing reverseDemo...
Making stage for tweak reverseDemo...
dpkg-deb：正在新建软件包“com.liuchendi.iosreverse”，包文件为“./com.liuchendi.iOSReverse_0.0.1-5_iphoneos-arm.deb”。
</code></pre>

<p>多了一个， _ 目录,里面有 DEBIAN 和 Library 文件夹</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ ls
Makefile
Tweak.xm
_
com.liuchendi.iOSReverse_0.0.1-5_iphoneos-arm.deb
control
obj
reverseDemo.plist
theos
liuchendi@lovelyddtekiMBP reversedemo$ ls _
DEBIAN  Library
</code></pre>

<p><img src="/images/nixiangtweak001.png" title="Caption" ></p>

<p>用 dpkg -c 查看生成的内容</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ dpkg -c com.liuchendi.iOSReverse_0.0.1-5_iphoneos-arm.deb
drwxr-xr-x liuchendi/staff   0 2015-12-17 23:48 ./
drwxr-xr-x liuchendi/staff   0 2015-12-17 23:48 ./Library/
drwxr-xr-x liuchendi/staff   0 2015-12-17 23:48 ./Library/MobileSubstrate/
drwxr-xr-x liuchendi/staff   0 2015-12-17 23:48 ./Library/MobileSubstrate/DynamicLibraries/
-rwxr-xr-x liuchendi/staff 49952 2015-12-17 23:48 ./Library/MobileSubstrate/DynamicLibraries/reverseDemo.dylib
-rw-r--r-- liuchendi/staff    57 2015-12-17 23:48 ./Library/MobileSubstrate/DynamicLibraries/reverseDemo.plist
</code></pre>

<p>可以看到内容都是一样的
安装</p>

<pre><code>make package install
</code></pre>

<p>首先在Makefile添加下面的内容,主要是指定安装的手机ip</p>

<pre><code>ARCHS = armv7 arm64
TARGET = iphone:latest:7.0
THEOS_DEVICE_IP = 192.168.1.100
</code></pre>

<p>安装成功后的显示,期间要输入两次密码</p>

<pre><code>liuchendi@lovelyddtekiMBP reversedemo$ make package install
Making all for tweak reverseDemo...
make[2]: Nothing to be done for `internal-library-compile'.
Making stage for tweak reverseDemo...
dpkg-deb：正在新建软件包“com.liuchendi.iosreverse”，包文件为“./com.liuchendi.iOSReverse_0.0.1-7_iphoneos-arm.deb”。
install.exec "cat &gt; /tmp/_theos_install.deb; dpkg -i /tmp/_theos_install.deb &amp;&amp; rm /tmp/_theos_install.deb" &lt; "./com.liuchendi.iOSReverse_0.0.1-7_iphoneos-arm.deb"
root@192.168.1.100's password: 
Selecting previously deselected package com.liuchendi.iosreverse.
(Reading database ... 2389 files and directories currently installed.)
Unpacking com.liuchendi.iosreverse (from /tmp/_theos_install.deb) ...
Setting up com.liuchendi.iosreverse (0.0.1-7) ...
install.exec "killall -9 SpringBoard"
root@192.168.1.100's password:
</code></pre>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">iCocos</span></span>

      




<time class='entry-date' datetime='2016-03-19T13:32:08+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:32 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/reverse/'>reverse</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/03/18/xiugaitubiaozhishishuzi/" title="Previous Post: 修改图标数字">&laquo; 修改图标数字</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/20/siyouapi/" title="Next Post: 私有API">私有API &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
    <h1>文章分类</h1>
    <ul id="categories">
        <li class='category'><a href='/blog/categories/apples/'>apples (2)</a></li>
<li class='category'><a href='/blog/categories/audio-video/'>audio-video (1)</a></li>
<li class='category'><a href='/blog/categories/developer/'>developer (14)</a></li>
<li class='category'><a href='/blog/categories/foundation/'>foundation (32)</a></li>
<li class='category'><a href='/blog/categories/full/'>full (13)</a></li>
<li class='category'><a href='/blog/categories/low-level/'>low-level (4)</a></li>
<li class='category'><a href='/blog/categories/news/'>news (4)</a></li>
<li class='category'><a href='/blog/categories/others/'>others (1)</a></li>
<li class='category'><a href='/blog/categories/performance/'>performance (12)</a></li>
<li class='category'><a href='/blog/categories/reverse/'>reverse (25)</a></li>
<li class='category'><a href='/blog/categories/senior/'>senior (38)</a></li>
<li class='category'><a href='/blog/categories/stack/'>stack (13)</a></li>
<li class='category'><a href='/blog/categories/summarize/'>summarize (5)</a></li>
<li class='category'><a href='/blog/categories/tools/'>tools (5)</a></li>

    </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/01/weixinhongbao/">福利：抢红包神器就是这么来的</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/26/chongzhengzhidao/">重整之道（面试+技术+底层+高级）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/10/duoxianc/">多线程之葵花宝典</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/zsqlfmdbcoredata/">CoreData vs SQLite vs FMDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/xsqlyucoredata/">CoreData vs SQLite</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/al1020119">@al1020119</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'al1020119',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
<h1>扫一扫<abbr title="The word '扫一扫' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word '扫一扫', not for image.">&trade;</abbr></h1>
<a href="http://al1020119.github.io/blog/2016/03/19/shiyongtweakgongcheng/"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=165B94&chl=http://al1020119.github.io/blog/2016/03/19/shiyongtweakgongcheng/" alt="post-qrcode"></a></section>
<section>
    <h1>访客统计</h1>
    <br/>
    <a href="http://s07.flagcounter.com/more/2SH"><img src="http://s07.flagcounter.com/count/2SH/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_1/flags_0/" alt="Flag Counter" border="0"></a>
</section><section>
    <h1>新浪微博</h1>
    <ul id="weibo">
        <li>
            
            <!-- 在此插入获得的微博秀代码 -->
            <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=3288975567&verifier=20ffcedd&dpc=1"></iframe>
            
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - iCocos -
<span class="credit">welcome to <a href="http://al1020119.github.io">曹#黎</a></span>
</p>

</footer>
  






<!--
-->



</body>
</html>
