
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>éŸ³è§†é¢‘ç¼–è§£ç æŠ€æœ¯ - iOSæ¢¦å·¥å‚</title>
  <meta name="author" content="iCocos">

  
  <meta name="description" content="ç›®å½• éŸ³é¢‘ç¼–è§£ç ï¼šAudioToolbox
è§†é¢‘ç¼–è§£ç ï¼šVideoToolbox
æ€»ç»“ è§†é¢‘ç¼–è§£ç ï¼šVideoToolbox å…³äºH264 H.264æ˜¯ç›®å‰å¾ˆæµè¡Œçš„ç¼–ç å±‚è§†é¢‘å‹ç¼©æ ¼å¼ï¼Œç›®å‰é¡¹ç›®ä¸­çš„åè®®å±‚æœ‰rtmpä¸httpï¼Œä½†æ˜¯è§†é¢‘çš„ç¼–ç å±‚éƒ½æ˜¯ä½¿ç”¨çš„H.264ã€‚
åœ¨ç†Ÿæ‚‰H.264çš„è¿‡ç¨‹ä¸­ï¼Œ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://al1020119.github.io/blog/2016/09/30/ios-yinshipjiema/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="iOSæ¢¦å·¥å‚" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

<!--<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">iOSæ¢¦å·¥å‚</a></h1>
  
    <h2>iCocosâ€”â€”ä¸æˆ˜èƒœè‡ªå·±ï¼Œä½•ä»¥æ”¹å˜æœªæ¥ï¼</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="al1020119.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">åšæ–‡</a></li>
  <li><a href="/blog/archives">å½’æ¡£</a></li>
  <li><a href="/icocos">iCocos</a></li>
  <li><a href="/about">æ–‡ç« </a></li>
  <li><a href="/other">å…¶ä»–</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">éŸ³è§†é¢‘ç¼–è§£ç æŠ€æœ¯</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-30T18:16:05+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:16 pm</span></time>
        
        
        |   <a href="#comments">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h4>ç›®å½•</h4>

<ol>
<li>éŸ³é¢‘ç¼–è§£ç ï¼šAudioToolbox</li>
<li>è§†é¢‘ç¼–è§£ç ï¼šVideoToolbox</li>
<li>æ€»ç»“</li>
</ol>


<h1>è§†é¢‘ç¼–è§£ç ï¼šVideoToolbox</h1>

<h3>å…³äºH264</h3>

<p>H.264æ˜¯ç›®å‰å¾ˆæµè¡Œçš„ç¼–ç å±‚è§†é¢‘å‹ç¼©æ ¼å¼ï¼Œç›®å‰é¡¹ç›®ä¸­çš„åè®®å±‚æœ‰rtmpä¸httpï¼Œä½†æ˜¯è§†é¢‘çš„ç¼–ç å±‚éƒ½æ˜¯ä½¿ç”¨çš„H.264ã€‚
åœ¨ç†Ÿæ‚‰H.264çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºæ›´å¥½çš„äº†è§£H.264ï¼Œå°è¯•ç”¨VideoToolboxç¡¬ç¼–ç ä¸ç¡¬è§£ç H.264çš„åŸå§‹ç æµã€‚</p>

<h3>H.264ç»„æˆ</h3>

<pre><code>1ã€ç½‘ç»œæå–å±‚ (Network Abstraction Layerï¼ŒNAL)
2ã€è§†è®¯ç¼–ç å±‚ (Video Coding Layerï¼ŒVCL)
</code></pre>

<!--more-->


<p>H.264ç”±è§†è®¯ç¼–ç å±‚(Video Coding Layerï¼ŒVCL)ä¸ç½‘ç»œæå–å±‚(Network Abstraction Layerï¼ŒNAL)ç»„æˆã€‚
H.264åŒ…å«ä¸€ä¸ªå†…å»ºçš„NALç½‘ç»œåè®®é€‚åº”å±‚ï¼Œè—‰ç”±NALæ¥æä¾›ç½‘ç»œçš„çŠ¶æ€ï¼Œè®©VCLæœ‰æ›´å¥½çš„ç¼–è¯‘ç å¼¹æ€§ä¸çº é”™èƒ½åŠ›ã€‚</p>

<h3>è§†é¢‘ç›¸å…³çš„æ¡†æ¶</h3>

<pre><code>AVKit
AVFoundation
Video Toolbox
Core Media
Core Video
</code></pre>

<p>å…¶ä¸­çš„AVKitå’ŒAVFoudationã€VideoToolboxéƒ½æ˜¯ä½¿ç”¨ç¡¬ç¼–ç å’Œç¡¬è§£ç ã€‚</p>

<h3>VideoToolbox</h3>

<p>VideoToolboxæ˜¯iOS8ä»¥åå¼€æ”¾çš„ç¡¬ç¼–ç ä¸ç¡¬è§£ç çš„APIï¼Œä¸€ç»„ç”¨Cè¯­è¨€å†™çš„å‡½æ•°ã€‚ä½¿ç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>

<pre><code>1ã€-initVideoToolBoxä¸­è°ƒç”¨VTCompressionSessionCreateåˆ›å»ºç¼–ç sessionï¼Œç„¶åè°ƒç”¨VTSessionSetPropertyè®¾ç½®å‚æ•°ï¼Œæœ€åè°ƒç”¨VTCompressionSessionPrepareToEncodeFrameså¼€å§‹ç¼–ç ï¼›
2ã€å¼€å§‹è§†é¢‘å½•åˆ¶ï¼Œè·å–åˆ°æ‘„åƒå¤´çš„è§†é¢‘å¸§ï¼Œä¼ å…¥-encode:ï¼Œè°ƒç”¨VTCompressionSessionEncodeFrameä¼ å…¥éœ€è¦ç¼–ç çš„è§†é¢‘å¸§ï¼Œå¦‚æœè¿”å›å¤±è´¥ï¼Œè°ƒç”¨VTCompressionSessionInvalidateé”€æ¯sessionï¼Œç„¶åé‡Šæ”¾sessionï¼›
3ã€æ¯ä¸€å¸§è§†é¢‘ç¼–ç å®Œæˆåä¼šè°ƒç”¨é¢„å…ˆè®¾ç½®çš„ç¼–ç å‡½æ•°didCompressH264ï¼Œå¦‚æœæ˜¯å…³é”®å¸§éœ€è¦ç”¨CMSampleBufferGetFormatDescriptionè·å–CMFormatDescriptionRefï¼Œç„¶åç”¨
CMVideoFormatDescriptionGetH264ParameterSetAtIndexå–å¾—PPSå’ŒSPSï¼›
æœ€åæŠŠæ¯ä¸€å¸§çš„æ‰€æœ‰NALUæ•°æ®å‰å››ä¸ªå­—èŠ‚å˜æˆ0x00 00 00 01ä¹‹åå†å†™å…¥æ–‡ä»¶ï¼›
4ã€è°ƒç”¨VTCompressionSessionCompleteFrameså®Œæˆç¼–ç ï¼Œç„¶åé”€æ¯sessionï¼šVTCompressionSessionInvalidateï¼Œé‡Šæ”¾sessionã€‚
</code></pre>

<h2>VideoToolboxç¼–ç H264å®ç°</h2>

<p>åˆ›å»ºsession</p>

<pre><code>     int width = 480, height = 640;
     OSStatus status = VTCompressionSessionCreate(NULL, width, height, kCMVideoCodecType_H264, NULL, NULL, NULL, didCompressH264, (__bridge void *)(self),  &amp;EncodingSession);
</code></pre>

<p>è®¾ç½®sessionå±æ€§</p>

<pre><code>     // è®¾ç½®å®æ—¶ç¼–ç è¾“å‡ºï¼ˆé¿å…å»¶è¿Ÿï¼‰
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_RealTime, kCFBooleanTrue);
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_ProfileLevel, kVTProfileLevel_H264_Baseline_AutoLevel);
     // è®¾ç½®å…³é”®å¸§ï¼ˆGOPsize)é—´éš”
     int frameInterval = 10;
     CFNumberRef  frameIntervalRef = CFNumberCreate(kCFAllocatorDefault, kCFNumberIntType, &amp;frameInterval);
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_MaxKeyFrameInterval, frameIntervalRef);
     // è®¾ç½®æœŸæœ›å¸§ç‡
     int fps = 10;
     CFNumberRef  fpsRef = CFNumberCreate(kCFAllocatorDefault, kCFNumberIntType, &amp;fps);
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_ExpectedFrameRate, fpsRef); 
     //è®¾ç½®ç ç‡ï¼Œä¸Šé™ï¼Œå•ä½æ˜¯bps
     int bitRate = width * height * 3 * 4 * 8;
     CFNumberRef bitRateRef = CFNumberCreate(kCFAllocatorDefault, kCFNumberSInt32Type, &amp;bitRate);
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_AverageBitRate, bitRateRef);
     //è®¾ç½®ç ç‡ï¼Œå‡å€¼ï¼Œå•ä½æ˜¯byte
     int bitRateLimit = width * height * 3 * 4;
     CFNumberRef bitRateLimitRef = CFNumberCreate(kCFAllocatorDefault, kCFNumberSInt32Type, &amp;bitRateLimit);
     VTSessionSetProperty(EncodingSession, kVTCompressionPropertyKey_DataRateLimits, bitRateLimitRef);
</code></pre>

<p>ä¼ å…¥ç¼–ç å¸§</p>

<pre><code> CVImageBufferRef imageBuffer = (CVImageBufferRef)CMSampleBufferGetImageBuffer(sampleBuffer);
 // å¸§æ—¶é—´ï¼Œå¦‚æœä¸è®¾ç½®ä¼šå¯¼è‡´æ—¶é—´è½´è¿‡é•¿ã€‚
 CMTime presentationTimeStamp = CMTimeMake(frameID++, 1000);
 VTEncodeInfoFlags flags;
 OSStatus statusCode = VTCompressionSessionEncodeFrame(EncodingSession,
                                                       imageBuffer,
                                                       presentationTimeStamp,
                                                       kCMTimeInvalid,
                                                       NULL, NULL, &amp;flags);
</code></pre>

<p>å…³é”®å¸§è·å–SPSå’ŒPPS</p>

<pre><code> bool keyframe = !CFDictionaryContainsKey( (CFArrayGetValueAtIndex(CMSampleBufferGetSampleAttachmentsArray(sampleBuffer, true), 0)), kCMSampleAttachmentKey_NotSync);
 // åˆ¤æ–­å½“å‰å¸§æ˜¯å¦ä¸ºå…³é”®å¸§
 // è·å–sps &amp; ppsæ•°æ®
 if (keyframe)
 {
     CMFormatDescriptionRef format = CMSampleBufferGetFormatDescription(sampleBuffer);
     size_t sparameterSetSize, sparameterSetCount;
     const uint8_t *sparameterSet;
     OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 0, &amp;sparameterSet, &amp;sparameterSetSize, &amp;sparameterSetCount, 0 );
     if (statusCode == noErr)
     {
         // Found sps and now check for pps
         size_t pparameterSetSize, pparameterSetCount;
         const uint8_t *pparameterSet;
         OSStatus statusCode = CMVideoFormatDescriptionGetH264ParameterSetAtIndex(format, 1, &amp;pparameterSet, &amp;pparameterSetSize, &amp;pparameterSetCount, 0 );
         if (statusCode == noErr)
         {
             // Found pps
             NSData *sps = [NSData dataWithBytes:sparameterSet length:sparameterSetSize];
             NSData *pps = [NSData dataWithBytes:pparameterSet length:pparameterSetSize];
             if (encoder)
             {
                 [encoder gotSpsPps:sps pps:pps];
             }
         }
     }
 }
</code></pre>

<p>å†™å…¥æ•°æ®</p>

<pre><code> CMBlockBufferRef dataBuffer = CMSampleBufferGetDataBuffer(sampleBuffer);
 size_t length, totalLength;
 char *dataPointer;
 OSStatus statusCodeRet = CMBlockBufferGetDataPointer(dataBuffer, 0, &amp;length, &amp;totalLength, &amp;dataPointer);
 if (statusCodeRet == noErr) {
     size_t bufferOffset = 0;
     static const int AVCCHeaderLength = 4; // è¿”å›çš„naluæ•°æ®å‰å››ä¸ªå­—èŠ‚ä¸æ˜¯0001çš„startcodeï¼Œè€Œæ˜¯å¤§ç«¯æ¨¡å¼çš„å¸§é•¿åº¦length

     // å¾ªç¯è·å–naluæ•°æ®
     while (bufferOffset &lt; totalLength - AVCCHeaderLength) {
         uint32_t NALUnitLength = 0;
         // Read the NAL unit length
         memcpy(&amp;NALUnitLength, dataPointer + bufferOffset, AVCCHeaderLength);

         // ä»å¤§ç«¯è½¬ç³»ç»Ÿç«¯
         NALUnitLength = CFSwapInt32BigToHost(NALUnitLength);

         NSData* data = [[NSData alloc] initWithBytes:(dataPointer + bufferOffset + AVCCHeaderLength) length:NALUnitLength];
         [encoder gotEncodedData:data isKeyFrame:keyframe];

         // Move to the next NAL unit in the block buffer
         bufferOffset += AVCCHeaderLength + NALUnitLength;
     }
 }
</code></pre>

<h2>VideoToolboxè§£ç ç H264å®ç°</h2>

<p>æ ¸å¿ƒæ€è·¯</p>

<p>ç”¨NSInputStreamè¯»å…¥åŸå§‹H.264ç æµï¼Œç”¨CADisplayLinkæ§åˆ¶æ˜¾ç¤ºé€Ÿç‡ï¼Œç”¨NALUçš„å‰å››ä¸ªå­—èŠ‚è¯†åˆ«SPSå’ŒPPSå¹¶å­˜å‚¨ï¼Œå½“è¯»å…¥IDRå¸§çš„æ—¶å€™åˆå§‹åŒ–VideoToolboxï¼Œå¹¶å¼€å§‹åŒæ­¥è§£ç ï¼›è§£ç å¾—åˆ°çš„CVPixelBufferRefä¼šä¼ å…¥OpenGL ESç±»è¿›è¡Œè§£ææ¸²æŸ“ã€‚
å…·ä½“ç»†èŠ‚
1ã€æŠŠåŸå§‹ç æµåŒ…è£…æˆCMSampleBuffer</p>

<p>1ã€æ›¿æ¢å¤´å­—èŠ‚é•¿åº¦ï¼›</p>

<pre><code>         uint32_t nalSize = (uint32_t)(packetSize - 4);
         uint32_t *pNalSize = (uint32_t *)packetBuffer;
         *pNalSize = CFSwapInt32HostToBig(nalSize);
</code></pre>

<p>2ã€ç”¨CMBlockBufferæŠŠNALUnitåŒ…è£…èµ·æ¥ï¼›</p>

<pre><code>     CMBlockBufferRef blockBuffer = NULL;
     OSStatus status  = CMBlockBufferCreateWithMemoryBlock(kCFAllocatorDefault,
                                                           (void*)packetBuffer, packetSize,
                                                           kCFAllocatorNull,
                                                           NULL, 0, packetSize,
                                                           0, &amp;blockBuffer);
</code></pre>

<p>3ã€æŠŠSPSå’ŒPPSåŒ…è£…æˆCMVideoFormatDescriptionï¼›</p>

<pre><code>     const uint8_t* parameterSetPointers[2] = {mSPS, mPPS};
     const size_t parameterSetSizes[2] = {mSPSSize, mPPSSize};
     OSStatus status = CMVideoFormatDescriptionCreateFromH264ParameterSets(kCFAllocatorDefault,
                                                                                       2, //param count
                                                                                       parameterSetPointers,
                                                                                       parameterSetSizes,
                                                                                       4, //nal start code size
                                                                                       &amp;mFormatDescription);
</code></pre>

<p>4ã€æ·»åŠ CMTimeæ—¶é—´ï¼›</p>

<pre><code>    ï¼ˆWWDCè§†é¢‘ä¸Šè¯´æœ‰ï¼Œä½†æ˜¯æˆ‘åœ¨å®ç°è¿‡ç¨‹æ²¡æœ‰æ‰¾åˆ°æ·»åŠ çš„åœ°æ–¹ï¼Œå¯èƒ½æ˜¯æˆ‘é—æ¼äº†ï¼‰
</code></pre>

<p>5ã€åˆ›å»ºCMSampleBufferï¼›</p>

<pre><code>         CMSampleBufferRef sampleBuffer = NULL;
         const size_t sampleSizeArray[] = {packetSize};
         status = CMSampleBufferCreateReady(kCFAllocatorDefault,
                                            blockBuffer,
                                            mFormatDescription,
                                            1, 0, NULL, 1, sampleSizeArray,
                                            &amp;sampleBuffer);
</code></pre>

<p>2ã€è§£ç å¹¶æ˜¾ç¤º</p>

<p>1ã€ä¼ å…¥CMSampleBuffer</p>

<pre><code>             VTDecodeFrameFlags flags = 0;
             VTDecodeInfoFlags flagOut = 0;
             // é»˜è®¤æ˜¯åŒæ­¥æ“ä½œã€‚
             // è°ƒç”¨didDecompressï¼Œè¿”å›åå†å›è°ƒ
             OSStatus decodeStatus = VTDecompressionSessionDecodeFrame(mDecodeSession,
                                                                       sampleBuffer,
                                                                       flags,
                                                                       &amp;outputPixelBuffer,
                                                                       &amp;flagOut);
</code></pre>

<p>2ã€å›è°ƒdidDecompress</p>

<pre><code>void didDecompress(void *decompressionOutputRefCon, void *sourceFrameRefCon, OSStatus status, VTDecodeInfoFlags infoFlags, CVImageBufferRef pixelBuffer, CMTime presentationTimeStamp, CMTime presentationDuration ){
 CVPixelBufferRef *outputPixelBuffer = (CVPixelBufferRef *)sourceFrameRefCon;
 *outputPixelBuffer = CVPixelBufferRetain(pixelBuffer);
}
</code></pre>

<p>3ã€æ˜¾ç¤ºè§£ç çš„ç»“æœ</p>

<pre><code>[self.mOpenGLView displayPixelBuffer:pixelBuffer];
</code></pre>

<p>ä»”ç»†å¯¹æ¯”ç¡¬ç¼–ç å’Œç¡¬è§£ç çš„å›¾åƒï¼Œä¼šå‘ç°ç¡¬ç¼–ç çš„å›¾åƒè¢«æ°´å¹³é•œåƒè¿‡ã€‚</p>

<pre><code>å½“é‡åˆ°IDRå¸§æ—¶ï¼Œæ›´åˆé€‚çš„åšæ³•æ˜¯é€šè¿‡
VTDecompressionSessionCanAcceptFormatDescriptionåˆ¤æ–­åŸæ¥çš„sessionæ˜¯å¦èƒ½æ¥å—æ–°çš„SPSå’ŒPPSï¼Œå¦‚æœä¸èƒ½å†æ–°å»ºsessionã€‚
</code></pre>

<h1>éŸ³é¢‘ç¼–è§£ç ï¼šAudioToolbox</h1>

<h3>AACé«˜çº§éŸ³é¢‘ç¼–ç </h3>

<p>AACï¼ˆAdvanced Audio Codingï¼‰ï¼Œä¸­æ–‡åï¼šé«˜çº§éŸ³é¢‘ç¼–ç ï¼Œå‡ºç°äº1997å¹´ï¼ŒåŸºäºMPEG-2çš„éŸ³é¢‘ç¼–ç æŠ€æœ¯ã€‚ç”±Fraunhofer IISã€æœæ¯”å®éªŒå®¤ã€AT&amp;Tã€Sonyç­‰å…¬å¸å…±åŒå¼€å‘ï¼Œç›®çš„æ˜¯å–ä»£MP3æ ¼å¼ã€‚</p>

<p>AACéŸ³é¢‘æ ¼å¼æœ‰ADIFå’ŒADTSï¼š</p>

<pre><code>ADIFï¼šAudio Data Interchange Format éŸ³é¢‘æ•°æ®äº¤æ¢æ ¼å¼ã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å¯ä»¥ç¡®å®šçš„æ‰¾åˆ°è¿™ä¸ªéŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œä¸éœ€è¿›è¡Œåœ¨éŸ³é¢‘æ•°æ®æµä¸­é—´å¼€å§‹çš„è§£ç ï¼Œå³å®ƒçš„è§£ç å¿…é¡»åœ¨æ˜ç¡®å®šä¹‰çš„å¼€å§‹å¤„è¿›è¡Œã€‚æ•…è¿™ç§æ ¼å¼å¸¸ç”¨åœ¨ç£ç›˜æ–‡ä»¶ä¸­ã€‚
ADTSï¼šAudio Data Transport Stream éŸ³é¢‘æ•°æ®ä¼ è¾“æµã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ä¸ªæœ‰åŒæ­¥å­—çš„æ¯”ç‰¹æµï¼Œè§£ç å¯ä»¥åœ¨è¿™ä¸ªæµä¸­ä»»ä½•ä½ç½®å¼€å§‹ã€‚å®ƒçš„ç‰¹å¾ç±»ä¼¼äºmp3æ•°æ®æµæ ¼å¼ã€‚
</code></pre>

<h3>AudioToolbox</h3>

<p>AudioToolboxè¿™ä¸ªåº“æ˜¯Cçš„æ¥å£ï¼Œåå‘äºåº•å±‚ï¼Œç”¨äºåœ¨çº¿æµåª’ä½“éŸ³ä¹çš„æ’­æ”¾ï¼Œå¯ä»¥è°ƒç”¨è¯¥åº“çš„ç›¸å…³æ¥å£è‡ªå·±å°è£…ä¸€ä¸ªåœ¨çº¿æ’­æ”¾å™¨ç±»ï¼ŒAudioStreameræ˜¯è€å¤–å°è£…çš„ä¸€ä¸ªæ’­æ”¾å™¨ç±»</p>

<pre><code>    â€¢   æ•°æ®ç±»å‹  
1.AudioFileStreamID             æ–‡ä»¶æµ  
2.AudioQueueRef                     æ’­æ”¾é˜Ÿåˆ—   
3.AudioStreamBasicDescription   æ ¼å¼åŒ–éŸ³é¢‘æ•°æ®  
4.AudioQueueBufferRef             æ•°æ®ç¼“å†²  

    â€¢   å›è°ƒå‡½æ•°  
1.AudioFileStream_PacketsProc       è§£æéŸ³é¢‘æ•°æ®å›è°ƒ  
2.AudioSessionInterruptionListener  éŸ³é¢‘ä¼šè¯è¢«æ‰“æ–­  
3.AudioQueueOutputCallback          ä¸€ä¸ªAudioQueueBufferRefæ’­æ”¾å®Œ  

    â€¢   ä¸»è¦å‡½æ•°  
0.AudioSessionInitialize (NULL, NULL, AudioSessionInterruptionListener, self);  
åˆå§‹åŒ–éŸ³é¢‘ä¼šè¯  

1.AudioFileStreamOpen(  
                        (void*)self,                            
                        &amp;AudioFileStreamPropertyListenerProc,   
                        &amp;AudioFileStreamPacketsProc,            
                        0,                                      
                        &amp;audio_file_stream);              
å»ºç«‹ä¸€ä¸ªæ–‡ä»¶æµAudioFileStreamIDï¼Œä¼ è¾“è§£æçš„æ•°æ®  

2.AudioFileStreamParseBytes(  
                          audio_file_stream,  
                          datalen,  
                          [data bytes],  
                          kAudioFileStreamProperty_FileFormat);   
è§£æéŸ³é¢‘æ•°æ®  

3.AudioQueueNewOutput(&amp;audio_format, AudioQueueOutputCallback, (void*)self, [[NSRunLoop currentRunLoop] getCFRunLoop], kCFRunLoopCommonModes, 0, &amp;audio_queue);  
åˆ›å»ºéŸ³é¢‘é˜Ÿåˆ—AudioQueueRef  

4.AudioQueueAllocateBuffer(queue, [data length], &amp;buffer);  
åˆ›å»ºéŸ³é¢‘ç¼“å†²æ•°æ®AudioQueueBufferRef  

5.AudioQueueEnqueueBuffer(queue, buffer, num_packets, packet_descriptions);  
æŠŠç¼“å†²æ•°æ®æ’é˜ŸåŠ å…¥åˆ°AudioQueueRefç­‰å¾…æ’­æ”¾  

6.AudioQueueStart(audio_queue, nil);    æ’­æ”¾  
7.AudioQueueStop(audio_queue, true);  
 AudioQueuePause(audio_queue);          åœæ­¢ã€æš‚åœ  

    â€¢   æ–­ç‚¹ç»­ä¼   
1ã€‚åœ¨httpè¯·æ±‚å¤´ä¸­è®¾ç½®æ•°æ®çš„è¯·æ±‚èŒƒå›´ï¼Œè¯·æ±‚å¤´ä¸­éƒ½æ˜¯key-valueæˆå¯¹  
    keyï¼šRange           value:bytes=0-1000  
    [request setValue:range  forHTTPHeaderField:@"Range"];  
å¯ä»¥å®ç°ï¼Œa.ç½‘ç»œæ–­å¼€åå†è¿æ¥èƒ½ç»§ç»­ä»åŸæ¥çš„æ–­ç‚¹ä¸‹è½½  
            b.å¯ä»¥å®ç°æ’­æ”¾è¿›åº¦å¯éšä¾¿æ‹‰åŠ¨  
</code></pre>

<h3>ç¼–ç å®ç°</h3>

<p>iOSä¸ŠæŠŠPCMéŸ³é¢‘ç¼–ç æˆAACéŸ³é¢‘æµ</p>

<pre><code>1ã€è®¾ç½®ç¼–ç å™¨ï¼ˆcodecï¼‰ï¼Œå¹¶å¼€å§‹å½•åˆ¶ï¼›
2ã€æ”¶é›†åˆ°PCMæ•°æ®ï¼Œä¼ ç»™ç¼–ç å™¨ï¼›
3ã€ç¼–ç å®Œæˆå›è°ƒcallbackï¼Œå†™å…¥æ–‡ä»¶ã€‚
</code></pre>

<p>å…·ä½“æ­¥éª¤
1ã€åˆ›å»ºå¹¶é…ç½®AVCaptureSession</p>

<p>åˆ›å»ºAVCaptureSessionï¼Œç„¶åæ‰¾åˆ°éŸ³é¢‘çš„AVCaptureDeviceï¼Œæ ¹æ®éŸ³é¢‘deviceåˆ›å»ºè¾“å…¥å¹¶æ·»åŠ åˆ°sessionï¼Œæœ€åæ·»åŠ outputåˆ°sessionã€‚</p>

<p>audioFileHandleæ˜¯NSFileHandleï¼Œç”¨æˆ·å†™å…¥ç¼–ç åçš„AACéŸ³é¢‘åˆ°æ–‡ä»¶ã€‚
demoä¸­ï¼Œæ­¤æ®µä»£ç è¿˜åŒ…æ‹¬Videoçš„è®¾ç½®ã€‚ä¸ºäº†ç¼©çŸ­ç¯‡å¹…ï¼Œå»æ‰äº†videoç›¸å…³çš„é…ç½®ã€‚</p>

<pre><code>- (void)startCapture {
    self.mCaptureSession = [[AVCaptureSession alloc] init];
    mCaptureQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    mEncodeQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

    AVCaptureDevice *audioDevice = [[AVCaptureDevice devicesWithMediaType:AVMediaTypeAudio] lastObject];
    self.mCaptureAudioDeviceInput = [[AVCaptureDeviceInput alloc] initWithDevice:audioDevice error:nil];
    if ([self.mCaptureSession canAddInput:self.mCaptureAudioDeviceInput]) {
        [self.mCaptureSession addInput:self.mCaptureAudioDeviceInput];
    }
    self.mCaptureAudioOutput = [[AVCaptureAudioDataOutput alloc] init];

    if ([self.mCaptureSession canAddOutput:self.mCaptureAudioOutput]) {
        [self.mCaptureSession addOutput:self.mCaptureAudioOutput];
    }
    [self.mCaptureAudioOutput setSampleBufferDelegate:self queue:mCaptureQueue];

    NSString *audioFile = [[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:@"abc.aac"];
    [[NSFileManager defaultManager] removeItemAtPath:audioFile error:nil];
    [[NSFileManager defaultManager] createFileAtPath:audioFile contents:nil attributes:nil];
    audioFileHandle = [NSFileHandle fileHandleForWritingAtPath:audioFile];

    [self.mCaptureSession startRunning];
}
</code></pre>

<p>2ã€åˆ›å»ºè½¬æ¢å™¨</p>

<p>AudioStreamBasicDescriptionæ˜¯è¾“å‡ºæµçš„ç»“æ„ä½“æè¿°ï¼Œ
é…ç½®å¥½outAudioStreamBasicDescriptionåï¼Œ
æ ¹æ®AudioClassDescriptionï¼ˆç¼–ç å™¨ï¼‰ï¼Œ
è°ƒç”¨AudioConverterNewSpecificåˆ›å»ºè½¬æ¢å™¨ã€‚</p>

<pre><code>/**
 *  è®¾ç½®ç¼–ç å‚æ•°
 *
 *  @param sampleBuffer éŸ³é¢‘
 */
- (void) setupEncoderFromSampleBuffer:(CMSampleBufferRef)sampleBuffer {
    AudioStreamBasicDescription inAudioStreamBasicDescription = *CMAudioFormatDescriptionGetStreamBasicDescription((CMAudioFormatDescriptionRef)CMSampleBufferGetFormatDescription(sampleBuffer));

    AudioStreamBasicDescription outAudioStreamBasicDescription = {0}; // åˆå§‹åŒ–è¾“å‡ºæµçš„ç»“æ„ä½“æè¿°ä¸º0. å¾ˆé‡è¦ã€‚
    outAudioStreamBasicDescription.mSampleRate = inAudioStreamBasicDescription.mSampleRate; // éŸ³é¢‘æµï¼Œåœ¨æ­£å¸¸æ’­æ”¾æƒ…å†µä¸‹çš„å¸§ç‡ã€‚å¦‚æœæ˜¯å‹ç¼©çš„æ ¼å¼ï¼Œè¿™ä¸ªå±æ€§è¡¨ç¤ºè§£å‹ç¼©åçš„å¸§ç‡ã€‚å¸§ç‡ä¸èƒ½ä¸º0ã€‚
    outAudioStreamBasicDescription.mFormatID = kAudioFormatMPEG4AAC; // è®¾ç½®ç¼–ç æ ¼å¼
    outAudioStreamBasicDescription.mFormatFlags = kMPEG4Object_AAC_LC; // æ— æŸç¼–ç  ï¼Œ0è¡¨ç¤ºæ²¡æœ‰
    outAudioStreamBasicDescription.mBytesPerPacket = 0; // æ¯ä¸€ä¸ªpacketçš„éŸ³é¢‘æ•°æ®å¤§å°ã€‚å¦‚æœçš„åŠ¨æ€å¤§å°ï¼Œè®¾ç½®ä¸º0ã€‚åŠ¨æ€å¤§å°çš„æ ¼å¼ï¼Œéœ€è¦ç”¨AudioStreamPacketDescription æ¥ç¡®å®šæ¯ä¸ªpacketçš„å¤§å°ã€‚
    outAudioStreamBasicDescription.mFramesPerPacket = 1024; // æ¯ä¸ªpacketçš„å¸§æ•°ã€‚å¦‚æœæ˜¯æœªå‹ç¼©çš„éŸ³é¢‘æ•°æ®ï¼Œå€¼æ˜¯1ã€‚åŠ¨æ€å¸§ç‡æ ¼å¼ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„å›ºå®šæ•°å­—ï¼Œæ¯”å¦‚è¯´AACçš„1024ã€‚å¦‚æœæ˜¯åŠ¨æ€å¤§å°å¸§æ•°ï¼ˆæ¯”å¦‚Oggæ ¼å¼ï¼‰è®¾ç½®ä¸º0ã€‚
    outAudioStreamBasicDescription.mBytesPerFrame = 0; //  æ¯å¸§çš„å¤§å°ã€‚æ¯ä¸€å¸§çš„èµ·å§‹ç‚¹åˆ°ä¸‹ä¸€å¸§çš„èµ·å§‹ç‚¹ã€‚å¦‚æœæ˜¯å‹ç¼©æ ¼å¼ï¼Œè®¾ç½®ä¸º0 ã€‚
    outAudioStreamBasicDescription.mChannelsPerFrame = 1; // å£°é“æ•°
    outAudioStreamBasicDescription.mBitsPerChannel = 0; // å‹ç¼©æ ¼å¼è®¾ç½®ä¸º0
    outAudioStreamBasicDescription.mReserved = 0; // 8å­—èŠ‚å¯¹é½ï¼Œå¡«0.
    AudioClassDescription *description = [self
                                          getAudioClassDescriptionWithType:kAudioFormatMPEG4AAC
                                          fromManufacturer:kAppleSoftwareAudioCodecManufacturer]; //è½¯ç¼–

    OSStatus status = AudioConverterNewSpecific(&amp;inAudioStreamBasicDescription, &amp;outAudioStreamBasicDescription, 1, description, &amp;_audioConverter); // åˆ›å»ºè½¬æ¢å™¨
    if (status != 0) {
        NSLog(@"setup converter: %d", (int)status);
    }
}
</code></pre>

<p>è·å–ç¼–ç å™¨çš„æ–¹æ³•</p>

<pre><code>/**
 *  è·å–ç¼–è§£ç å™¨
 *
 *  @param type         ç¼–ç æ ¼å¼
 *  @param manufacturer è½¯/ç¡¬ç¼–
 *
 ç¼–è§£ç å™¨ï¼ˆcodecï¼‰æŒ‡çš„æ˜¯ä¸€ä¸ªèƒ½å¤Ÿå¯¹ä¸€ä¸ªä¿¡å·æˆ–è€…ä¸€ä¸ªæ•°æ®æµè¿›è¡Œå˜æ¢çš„è®¾å¤‡æˆ–è€…ç¨‹åºã€‚è¿™é‡ŒæŒ‡çš„å˜æ¢æ—¢åŒ…æ‹¬å°† ä¿¡å·æˆ–è€…æ•°æ®æµè¿›è¡Œç¼–ç ï¼ˆé€šå¸¸æ˜¯ä¸ºäº†ä¼ è¾“ã€å­˜å‚¨æˆ–è€…åŠ å¯†ï¼‰æˆ–è€…æå–å¾—åˆ°ä¸€ä¸ªç¼–ç æµçš„æ“ä½œï¼Œä¹ŸåŒ…æ‹¬ä¸ºäº†è§‚å¯Ÿæˆ–è€…å¤„ç†ä»è¿™ä¸ªç¼–ç æµä¸­æ¢å¤é€‚åˆè§‚å¯Ÿæˆ–æ“ä½œçš„å½¢å¼çš„æ“ä½œã€‚ç¼–è§£ç å™¨ç»å¸¸ç”¨åœ¨è§†é¢‘ä¼šè®®å’Œæµåª’ä½“ç­‰åº”ç”¨ä¸­ã€‚
 *  @return æŒ‡å®šç¼–ç å™¨
 */
- (AudioClassDescription *)getAudioClassDescriptionWithType:(UInt32)type
                                           fromManufacturer:(UInt32)manufacturer
{
    static AudioClassDescription desc;

    UInt32 encoderSpecifier = type;
    OSStatus st;

    UInt32 size;
    st = AudioFormatGetPropertyInfo(kAudioFormatProperty_Encoders,
                                    sizeof(encoderSpecifier),
                                    &amp;encoderSpecifier,
                                    &amp;size);
    if (st) {
        NSLog(@"error getting audio format propery info: %d", (int)(st));
        return nil;
    }

    unsigned int count = size / sizeof(AudioClassDescription);
    AudioClassDescription descriptions[count];
    st = AudioFormatGetProperty(kAudioFormatProperty_Encoders,
                                sizeof(encoderSpecifier),
                                &amp;encoderSpecifier,
                                &amp;size,
                                descriptions);
    if (st) {
        NSLog(@"error getting audio format propery: %d", (int)(st));
        return nil;
    }

    for (unsigned int i = 0; i &lt; count; i++) {
        if ((type == descriptions[i].mSubType) &amp;&amp;
            (manufacturer == descriptions[i].mManufacturer)) {
            memcpy(&amp;desc, &amp;(descriptions[i]), sizeof(desc));
            return &amp;desc;
        }
    }

    return nil;
}
</code></pre>

<p>3ã€è·å–åˆ°PCMæ•°æ®å¹¶ä¼ å…¥ç¼–ç å™¨</p>

<p>ç”¨CMSampleBufferGetDataBufferè·å–åˆ°CMSampleBufferRefé‡Œé¢çš„CMBlockBufferRefï¼Œå†é€šè¿‡CMBlockBufferGetDataPointerè·å–åˆ°<em>pcmBufferSizeå’Œ</em>pcmBufferï¼›
è°ƒç”¨AudioConverterFillComplexBufferä¼ å…¥æ•°æ®ï¼Œå¹¶åœ¨callBackå‡½æ•°è°ƒç”¨å¡«å……bufferçš„æ–¹æ³•ã€‚</p>

<pre><code>    CMBlockBufferRef blockBuffer = CMSampleBufferGetDataBuffer(sampleBuffer);
    CFRetain(blockBuffer);
    OSStatus status = CMBlockBufferGetDataPointer(blockBuffer, 0, NULL, &amp;_pcmBufferSize, &amp;_pcmBuffer);
    NSError *error = nil;
    if (status != kCMBlockBufferNoErr) {
        error = [NSError errorWithDomain:NSOSStatusErrorDomain code:status userInfo:nil];
    }
    memset(_aacBuffer, 0, _aacBufferSize);

    AudioBufferList outAudioBufferList = {0};
    outAudioBufferList.mNumberBuffers = 1;
    outAudioBufferList.mBuffers[0].mNumberChannels = 1;
    outAudioBufferList.mBuffers[0].mDataByteSize = (int)_aacBufferSize;
    outAudioBufferList.mBuffers[0].mData = _aacBuffer;
    AudioStreamPacketDescription *outPacketDescription = NULL;
    UInt32 ioOutputDataPacketSize = 1;
    // Converts data supplied by an input callback function, supporting non-interleaved and packetized formats.
    // Produces a buffer list of output data from an AudioConverter. The supplied input callback function is called whenever necessary.
    status = AudioConverterFillComplexBuffer(_audioConverter, inInputDataProc, (__bridge void *)(self), &amp;ioOutputDataPacketSize, &amp;outAudioBufferList, outPacketDescription);
</code></pre>

<p>Callbackå‡½æ•°</p>

<pre><code>/**
 *  A callback function that supplies audio data to convert. This callback is invoked repeatedly as the converter is ready for new input data.

 */
OSStatus inInputDataProc(AudioConverterRef inAudioConverter, UInt32 *ioNumberDataPackets, AudioBufferList *ioData, AudioStreamPacketDescription **outDataPacketDescription, void *inUserData)
{
    AACEncoder *encoder = (__bridge AACEncoder *)(inUserData);
    UInt32 requestedPackets = *ioNumberDataPackets;

    size_t copiedSamples = [encoder copyPCMSamplesIntoBuffer:ioData];
    if (copiedSamples &lt; requestedPackets) {
        //PCM ç¼“å†²åŒºè¿˜æ²¡æ»¡
        *ioNumberDataPackets = 0;
        return -1;
    }
    *ioNumberDataPackets = 1;

    return noErr;
}

/**
 *  å¡«å……PCMåˆ°ç¼“å†²åŒº
 */
- (size_t) copyPCMSamplesIntoBuffer:(AudioBufferList*)ioData {
    size_t originalBufferSize = _pcmBufferSize;
    if (!originalBufferSize) {
        return 0;
    }
    ioData-&gt;mBuffers[0].mData = _pcmBuffer;
    ioData-&gt;mBuffers[0].mDataByteSize = (int)_pcmBufferSize;
    _pcmBuffer = NULL;
    _pcmBufferSize = 0;
    return originalBufferSize;
}
</code></pre>

<p>4ã€å¾—åˆ°rawAACç æµï¼Œæ·»åŠ ADTSå¤´ï¼Œå¹¶å†™å…¥æ–‡ä»¶</p>

<p>AudioConverterFillComplexBufferè¿”å›çš„æ˜¯AACåŸå§‹ç æµï¼Œéœ€è¦åœ¨AACæ¯å¸§æ·»åŠ ADTSå¤´ï¼Œè°ƒç”¨adtsDataForPacketLengthæ–¹æ³•ç”Ÿæˆï¼Œæœ€åæŠŠæ•°æ®å†™å…¥audioFileHandleçš„æ–‡ä»¶ã€‚</p>

<pre><code>    if (status == 0) {
        NSData *rawAAC = [NSData dataWithBytes:outAudioBufferList.mBuffers[0].mData length:outAudioBufferList.mBuffers[0].mDataByteSize];
        NSData *adtsHeader = [self adtsDataForPacketLength:rawAAC.length];
        NSMutableData *fullData = [NSMutableData dataWithData:adtsHeader];
        [fullData appendData:rawAAC];
        data = fullData;
    } else {
        error = [NSError errorWithDomain:NSOSStatusErrorDomain code:status userInfo:nil];
    }
    if (completionBlock) {
        dispatch_async(_callbackQueue, ^{
            completionBlock(data, error);
        });
    }
</code></pre>

<p>ç½‘ä¸Šçš„ADTSå¤´ç”Ÿæˆæ–¹æ³•</p>

<pre><code>/**
 *  Add ADTS header at the beginning of each and every AAC packet.
 *  This is needed as MediaCodec encoder generates a packet of raw
 *  AAC data.
 *
 *  Note the packetLen must count in the ADTS header itself.
 *  See: http://wiki.multimedia.cx/index.php?title=ADTS
 *  Also: http://wiki.multimedia.cx/index.php?title=MPEG-4_Audio#Channel_Configurations
 **/
- (NSData*) adtsDataForPacketLength:(NSUInteger)packetLength {
    int adtsLength = 7;
    char *packet = malloc(sizeof(char) * adtsLength);
    // Variables Recycled by addADTStoPacket
    int profile = 2;  //AAC LC
    //39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;
    int freqIdx = 4;  //44.1KHz
    int chanCfg = 1;  //MPEG-4 Audio Channel Configuration. 1 Channel front-center
    NSUInteger fullLength = adtsLength + packetLength;
    // fill in ADTS data
    packet[0] = (char)0xFF; // 11111111     = syncword
    packet[1] = (char)0xF9; // 1111 1 00 1  = syncword MPEG-2 Layer CRC
    packet[2] = (char)(((profile-1)&lt;&lt;6) + (freqIdx&lt;&lt;2) +(chanCfg&gt;&gt;2));
    packet[3] = (char)(((chanCfg&amp;3)&lt;&lt;6) + (fullLength&gt;&gt;11));
    packet[4] = (char)((fullLength&amp;0x7FF) &gt;&gt; 3);
    packet[5] = (char)(((fullLength&amp;7)&lt;&lt;5) + 0x1F);
    packet[6] = (char)0xFC;
    NSData *data = [NSData dataWithBytesNoCopy:packet length:adtsLength freeWhenDone:YES];
    return data;
}
</code></pre>

<h3>æ’­æ”¾ACC</h3>

<p>åœ¨iOSè®¾å¤‡ä¸Šæ’­æ”¾éŸ³é¢‘ï¼Œå¯ä»¥ä½¿ç”¨AVAudioPlayerï¼ˆAVFoundationæ¡†æ¶å†…ï¼‰ï¼Œä½†æ˜¯ä¸æ”¯æŒæµå¼æ’­æ”¾ã€‚</p>

<p>æœ¬æ–‡å°è¯•ä¸¤ç§æ’­æ”¾æ–¹å¼ï¼š</p>

<pre><code>ä½¿ç”¨AudioServicesPlaySystemSoundï¼ˆéŸ³é¢‘å°äºç­‰äº30sï¼‰ï¼›
ä½¿ç”¨Audio Queue ServiceséŸ³é¢‘é˜Ÿåˆ—ï¼›
</code></pre>

<p>1ã€ä½¿ç”¨AudioServicesPlaySystemSound</p>

<pre><code>AudioServicesCreateSystemSoundIDåˆ›å»ºç³»ç»Ÿå£°éŸ³
AudioServicesAddSystemSoundCompletionè®¾ç½®å›è°ƒ
AudioServicesPlaySystemSoundå¼€å§‹æ’­æ”¾

- (void)onClick:(UIButton *)button {
    [self.mButton setHidden:YES];
    NSURL *audioURL=[[NSBundle mainBundle] URLForResource:@"abc" withExtension:@"aac"];
    SystemSoundID soundID;
    //Creates a system sound object.
    AudioServicesCreateSystemSoundID((__bridge CFURLRef)(audioURL), &amp;soundID);
    //Registers a callback function that is invoked when a specified system sound finishes playing.
    AudioServicesAddSystemSoundCompletion(soundID, NULL, NULL, &amp;playCallback, (__bridge void * _Nullable)(self));
    //    AudioServicesPlayAlertSound(soundID);
    AudioServicesPlaySystemSound(soundID);
}
- (void)onPlayCallback {
    [self.mButton setHidden:NO];
}
</code></pre>

<p>ä»¥ä¸‹æ˜¯APIçš„é™åˆ¶</p>

<pre><code>    No longer than 30 seconds in duration
    In linear PCM or IMA4 (IMA/ADPCM) format
    Packaged in a .caf, .aif, or .wav file

è™½ç„¶AACéŸ³é¢‘ä¸åœ¨æ”¯æŒåˆ—è¡¨é‡Œé¢ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•ï¼Œæ’­æ”¾æ˜¯å¯ä»¥çš„ã€‚
</code></pre>

<p>2ã€ä½¿ç”¨Audio Queue ServiceséŸ³é¢‘é˜Ÿåˆ—</p>

<p>Audio Queue Servicesçš„æ’­æ”¾æ­¥éª¤å¦‚ä¸‹ï¼š</p>

<pre><code>1ï¼Œç»™bufferå¡«å……æ•°æ®ï¼Œå¹¶æŠŠbufferæ”¾å…¥å°±ç»ªçš„buffer queueï¼›
2ï¼Œåº”ç”¨é€šçŸ¥é˜Ÿåˆ—å¼€å§‹æ’­æ”¾ï¼›
3ã€é˜Ÿåˆ—æ’­æ”¾ç¬¬ä¸€ä¸ªå¡«å……çš„bufferï¼›
4ã€é˜Ÿåˆ—è¿”å›å·²ç»æ’­æ”¾å®Œæ¯•çš„bufferï¼Œå¹¶å¼€å§‹æ’­æ”¾ä¸‹é¢ä¸€ä¸ªå¡«å……å¥½çš„bufferï¼›
5ã€é˜Ÿåˆ—è°ƒç”¨ä¹‹å‰è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œå¡«å……æ’­æ”¾å®Œæ¯•çš„bufferï¼›
6ã€å›è°ƒå‡½æ•°ä¸­æŠŠbufferå¡«å……å®Œæ¯•ï¼Œå¹¶æ”¾å…¥buffer queueä¸­ã€‚
</code></pre>

<h6>é‡åˆ°çš„é—®é¢˜</h6>

<p>é—®é¢˜1ï¼šmallocé”™è¯¯</p>

<pre><code>malloc: *** error for object 0x154e58498: incorrect checksum for freed object - object was probably modified after being freed.
Set a breakpoint in malloc_error_break to debug.
</code></pre>

<p>é—®é¢˜2ï¼šselectorè°ƒç”¨é”™è¯¯</p>

<pre><code>Method cache corrupted. This may be a message to an invalid object, or a memory error somewhere else.
objc[12730]: receiver 0x13fe1d4f0, SEL 0x10004e2d8, isa 0x100051828, cache 0x100051838, buckets 0x13fd86650, mask 0x7, occupied 0x1
objc[12730]: receiver 112 bytes, buckets 128 bytes
objc[12730]: selector 'fillBuffer:'
objc[12730]: isa 'AACPlayer'
objc[12730]: Method cache corrupted.
</code></pre>

<p>è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯å‡ºç°åœ¨AudioQueueAllocateBufferæ–¹æ³•å’ŒfillBufferçš„è°ƒç”¨ï¼Œè€Œä¸”æ˜¯æ—¶è€Œæ­£å¸¸ï¼Œæ—¶è€Œå´©æºƒã€‚
å…ˆæŸ¥çœ‹å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œé€šè¿‡xcodeçš„debugå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹çš„æ•°æ®ï¼š</p>

<pre><code>(AudioStreamBasicDescription) $0 = {
  mSampleRate = 44100
  mFormatID = 1633772320
  mFormatFlags = 0
  mBytesPerPacket = 0
  mFramesPerPacket = 1024
  mBytesPerFrame = 0
  mChannelsPerFrame = 1
  mBitsPerChannel = 0
  mReserved = 0
}
maxSize = 768
packetNums = 85
(mStartOffset = 0, mVariableFramesInPacket = 0, mDataByteSize = 23)
</code></pre>

<p>AudioStreamBasicDescriptionçš„å‚æ•°å¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡çš„ç¼–ç æ‰€è®¾ç½®çš„å‚æ•°ã€‚
AudioQueueAllocateBufferçš„å‚æ•°audioQueueã€buffer_sizeã€audioBufferséƒ½å¾ˆæ­£å¸¸ï¼Œæš‚æ—¶æ’é™¤å­˜åœ¨é—®é¢˜çš„å¯èƒ½æ€§ã€‚</p>

<pre><code>fillBufferæ–¹æ³•ä¸­ï¼Œæœ‰AudioFileReadPacketså’ŒAudioQueueEnqueueBufferä¸¤ä¸ªæ–¹æ³•ã€‚AudioQueueEnqueueBufferæ˜¯æŠŠbufferæ”¾å…¥åˆ°AudioQueueï¼Œå‚æ•°æ£€æŸ¥æ²¡æœ‰é—®é¢˜ã€‚åˆæ­¥åˆ¤æ–­æ˜¯AudioFileReadPacketså­˜åœ¨é—®é¢˜ã€‚
</code></pre>

<p>é€šè¿‡å¤šæ¬¡è°ƒè¯•ï¼Œå‘ç°AudioFileReadPacketsåœ¨å¶ç„¶æƒ…å†µä¸‹å›è¿”å›-60çš„æƒ…å†µï¼Œè¿™æ—¶ä¼šå¯¼è‡´å´©æºƒã€‚
é€šè¿‡googleæŸ¥åˆ°-60å¯¹åº”çš„æ˜¯kAudioFilePositionErrorï¼Œå›æ¥æ£€æŸ¥AudioFileReadPacketsçš„å‚æ•°ï¼Œå‘ç°å‚æ•°æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¯æ¬¡è°ƒç”¨çš„å‚æ•°éƒ½ä¸åŒã€‚
æŸ¥APIæ–‡æ¡£çŸ¥é“AudioFileReadPacketsçš„å‚æ•°é™¤äº†audioFileIDå’Œcacheã€packeté•¿åº¦ï¼Œå‡ä¸ºä¼ å…¥å‚æ•°ï¼Œå‚æ•°æ˜¯å¦åˆå§‹åŒ–å¹¶ä¸ä¼šå½±å“ã€‚è‡³æ­¤ï¼ŒfillBufferæ–¹æ³•çš„çº¿ç´¢æ–­äº†ã€‚
å›é¡¾äº†ä¸€ä¸‹æ•´ä½“çš„æµç¨‹ï¼Œå†³å®šä»mallocé”™è¯¯å…¥æ‰‹ï¼Œåœ¨soä¸Šæ‰¾åˆ°ä»¥ä¸‹è§£é‡Šã€‚</p>

<pre><code>    you are freeing an object twice,
    you are freeing a pointer that was never allocated
    you are writing through an invalid pointer which previously pointed to an object which was already freed
</code></pre>

<p>å†…å­˜è®¿é—®è¶Šç•Œï¼Œæ€ä¹ˆä¼šå’Œselectorè°ƒç”¨é”™è¯¯æ‰¯ä¸Šå…³ç³»ï¼Ÿç™¾æ€ä¸å¾—å…¶è§£ã€‚</p>

<p>æœ€åï¼Œå‡ ç»æ³¢æŠ˜ç»ˆäºæ‰¾åˆ°ç½ªé­ç¥¸é¦–ã€‚å°±æ˜¯ä»¥ä¸‹è¿™è¡Œä»£ç ï¼š</p>

<pre><code>audioStreamPacketDescrption = malloc(sizeof(audioStreamPacketDescrption) * packetNums);
</code></pre>

<p>å½“æˆ‘æ‰“è¿‡ä¸€æ¬¡audioStreamPacketDescrptionï¼Œå†æ‰“AudioStreamPacketDescrptionçš„æ—¶å€™ï¼ŒXcodeä¼šè‡ªåŠ¨ç´¢å¼•ä¸ºaudioStreamPacketDescrptionï¼Œå¯¼è‡´sizeofä¼šè®¡ç®—å‡ºä¸åŒçš„å¤§å°ã€‚</p>

<pre><code>PSï¼šæŒ‰ç†è¯´å¯¹ä¸€ä¸ªç»“æ„ä½“çš„ç±»å’Œç»“æ„ä½“çš„å®ä¾‹è¿›è¡Œsizeofï¼Œåº”è¯¥æ˜¯ä¸€æ ·çš„å¤§å°ï¼ˆä¸ç®—åŠ¨æ€åˆ†é…ï¼‰ã€‚
è¿™ä¸ªå¹¶æ²¡æœ‰é”™ï¼Œå¯æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘æŠŠaudioStreamPacketDescrptionå®šä¹‰æˆæŒ‡é’ˆäº†ï¼
</code></pre>

<p>ä¸¤ä¸ªæ•™è®­ï¼š</p>

<pre><code>1ã€ä¸è¦èµ·å’Œç±»åä¸€æ ·çš„å˜é‡ï¼›
2ã€æŒ‡é’ˆå’Œå®ä¾‹çš„åŒºåˆ«è¦ä»åå­—å³å¯åˆ†æ¸…ï¼›
</code></pre>

<h2>æ€»ç»“</h2>

<h6>åˆå¹¶H264+ACC=MP4ï¼š</h6>

<pre><code>ffmpeg -i abc.h264 -i abc.aac -vcodec copy -f mp4 abc.mp4
</code></pre>

<h6>ç‚¹æ’­çš„æ ¸å¿ƒæ€è·¯ï¼š<a href="http://www.jianshu.com/p/39a1a8e78675">å®ç°åœ°å€</a></h6>

<pre><code>ç”¨FFmpegæŠŠH.264å’ŒAACç æµå°è£…æˆmp4æ ¼å¼å†æ‰“åŒ…æˆTSæµï¼ŒæŠŠç”Ÿæˆçš„tså’Œm3u8æ–‡ä»¶æ”¾åˆ°Nginxçš„æœåŠ¡å™¨ç›®å½•ä¸‹ï¼Œç”¨Safariè®¿é—®å¯¹åº”çš„m3u8æ–‡ä»¶å®ç°HLSçš„ç‚¹æ’­ã€‚
å®‰è£…Homebrow-&gt;å®‰è£…Nginx-&gt;å®‰è£…FFmpeg-&gt;æ‰“åŒ…tsæµå¹¶æ”¾å…¥æœåŠ¡å™¨==&gt;ç›´æ’­å’Œæ¨æµ
</code></pre>

<h6>æ¨æµçš„æ ¸å¿ƒæ€è·¯:<a href="http://www.jianshu.com/p/ba5045da282c">å®ç°åœ°å€</a>(LFLiveKit)</h6>

<pre><code>é…ç½®Nginxä»¥æ”¯æŒHLSçš„æ¨æµä¸æ‹‰æµï¼ŒiOSç³»ç»Ÿä½¿ç”¨LFLiveKitæ¨æµï¼ŒOS Xç³»ç»Ÿä½¿ç”¨FFmpegæ¨æµï¼Œæ‹‰æµç«¯å¯ä»¥ä½¿ç”¨Safariæµè§ˆå™¨æˆ–è€…VLCæ’­æ”¾å™¨ã€‚

é…ç½®Nginxï¼Œæ”¯æŒhttpåè®®æ‹‰æµ-&gt;é…ç½®Nginxï¼Œæ”¯æŒrtmpåè®®æ¨æµ-&gt;é‡å¯Nginx-&gt;OS Xç³»ç»Ÿæ¨æµ-&gt;iOSç³»ç»Ÿæ¨æµ-&gt;Safariæµè§ˆå™¨æ‹‰æµ-&gt;VLCæ’­æ”¾å™¨æ‹‰æµ
</code></pre>

<h6>ç›¸å…³å¸¸è¯†</h6>

<ul>
<li>é‡‡é›†è§†é¢‘æºå’ŒéŸ³é¢‘æºçš„æ•°æ®ï¼Œè§†é¢‘é‡‡ç”¨H264ç¼–ç ï¼ŒéŸ³é¢‘é‡‡ç”¨AACç¼–ç </li>
<li>è§†é¢‘å’ŒéŸ³é¢‘æ•°æ®ä½¿ç”¨FFmpegå°è£…ä¸ºMPEG-TSåŒ…å’ŒMP4æ–‡ä»¶</li>
<li>ä½¿ç”¨FFmpegæ¨æµ(LFLiveKit)</li>
<li>ä½¿ç”¨æ‹‰æµijkPlayer</li>
</ul>


<hr />

<pre><code>Q Qï¼š2211523682/790806573

å¾®ä¿¡ï¼š18370997821/13148454507

å¾®åšWB:http://weibo.com/u/3288975567?is_hot=1

gitåšæ–‡ï¼šhttp://al1020119.github.io/

githubï¼šhttps://github.com/al1020119
</code></pre>

<p><img src="/images/iCocosCoder.jpg" title="Caption" ></p>

<p><img src="/images/iCocosPublic.jpg" title="Caption" ></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">iCocos</span></span>

      




<time class='entry-date' datetime='2016-09-30T18:16:05+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:16 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/09/28/mvvmjian-dan-shi-zhan-pian/" title="Previous Post: MVVMç®€å•å®æˆ˜ç¯‡">&laquo; MVVMç®€å•å®æˆ˜ç¯‡</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/10/01/zui-xin-shu-dan/" title="Next Post: æœ€æ–°ä¹¦å•">æœ€æ–°ä¹¦å• &raquo;</a>
      
    </p>
  </footer>
</article>



  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-title="éŸ³è§†é¢‘ç¼–è§£ç æŠ€æœ¯"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"icocoscao"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END --></div>
  </section>


</div>

<aside class="sidebar">
  
    <section>
    <h1>æ–‡ç« åˆ†ç±»</h1>
    <ul id="categories">
        <li class='category'><a href='/blog/categories/algorithms/'>algorithms (6)</a></li>
<li class='category'><a href='/blog/categories/and/'>and (11)</a></li>
<li class='category'><a href='/blog/categories/apples/'>apples (2)</a></li>
<li class='category'><a href='/blog/categories/application/'>application (1)</a></li>
<li class='category'><a href='/blog/categories/architecture/'>architecture (2)</a></li>
<li class='category'><a href='/blog/categories/audio/'>audio (5)</a></li>
<li class='category'><a href='/blog/categories/audio-video/'>audio-video (1)</a></li>
<li class='category'><a href='/blog/categories/data/'>data (6)</a></li>
<li class='category'><a href='/blog/categories/developer/'>developer (16)</a></li>
<li class='category'><a href='/blog/categories/foundation/'>foundation (31)</a></li>
<li class='category'><a href='/blog/categories/full/'>full (13)</a></li>
<li class='category'><a href='/blog/categories/low-level/'>low-level (4)</a></li>
<li class='category'><a href='/blog/categories/lve/'>lve (5)</a></li>
<li class='category'><a href='/blog/categories/news/'>news (4)</a></li>
<li class='category'><a href='/blog/categories/others/'>others (1)</a></li>
<li class='category'><a href='/blog/categories/performance/'>performance (12)</a></li>
<li class='category'><a href='/blog/categories/php-lover/'>php-lover (2)</a></li>
<li class='category'><a href='/blog/categories/practical/'>practical (1)</a></li>
<li class='category'><a href='/blog/categories/radio/'>radio (5)</a></li>
<li class='category'><a href='/blog/categories/reverse/'>reverse (7)</a></li>
<li class='category'><a href='/blog/categories/senior/'>senior (31)</a></li>
<li class='category'><a href='/blog/categories/stack/'>stack (13)</a></li>
<li class='category'><a href='/blog/categories/structures/'>structures (6)</a></li>
<li class='category'><a href='/blog/categories/summarize/'>summarize (5)</a></li>
<li class='category'><a href='/blog/categories/tools/'>tools (5)</a></li>
<li class='category'><a href='/blog/categories/video/'>video (5)</a></li>

    </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/08/bao-chi-chu-cin-ji-xu-qian-jin/">ä¿æŒåˆå¿ƒç»§ç»­å‰è¿›-å¹´ç»ˆç¯‡</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/06/ios-daobao/">è‡ªåŠ¨æ‰“åŒ…ä¸Šä¼ ä»£ç </a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/03/phpwan-mei-da-pei-mysql/">PHPå®Œç¾æ­é…ä¹‹Mysqlåˆæ¢</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/02/zhong-zheng-linux/">é‡æ•´Linuxä¸€æ¬¡å°±å¤Ÿäº†</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/01/wan-zhuan-thinkphp-5-dot-star/">å®Œè™ThinkPHP 5.* è¿œä¸æ­¢è¿™äº›ğŸ˜±ğŸ˜‚</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/al1020119">@al1020119</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'al1020119',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





<section>
<h1>åšå®¢<abbr title="The word 'åšå®¢' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'åšå®¢', not for image.">&trade;</abbr></h1>
<a href="http://al1020119.github.io/blog/2016/09/30/ios-yinshipjiema/"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=165B94&chl=http://al1020119.github.io/blog/2016/09/30/ios-yinshipjiema/" alt="post-qrcode"></a></section>


<section>
<h1>github<abbr title="The word 'github' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'github', not for image.">&trade;</abbr></h1>
<a><img src="/images/iCocosgithub.png" alt="post-qrcode"></a></section>


<section>
<h1>å¾®ä¿¡<abbr title="The word 'å¾®ä¿¡' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'å¾®ä¿¡', not for image.">&trade;</abbr></h1>
<a><img src="/images/iCocosWX.png" alt="post-qrcode"></a></section>


<section>
<h1>å…¬ä¼—å·<abbr title="The word 'å…¬ä¼—å·' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'å…¬ä¼—å·', not for image.">&trade;</abbr></h1>
<a><img src="/images/iCocosMGC.png" alt="post-qrcode"></a><section>
  
  
</section>
<h1>å…¬ä¼—å·<abbr title="The word 'å…¬ä¼—å·' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'å…¬ä¼—å·', not for image.">&trade;</abbr></h1>
<a><img src="/images/iCocos520.png" alt="post-qrcode"></a></section>
<section>
    <h1>è®¿å®¢ç»Ÿè®¡</h1>
    <br/>
    <a href="http://s07.flagcounter.com/more/2SH"><img src="http://s07.flagcounter.com/count/2SH/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_1/flags_0/" alt="Flag Counter" border="0"></a>
</section><section>
    <h1>æ–°æµªå¾®åš</h1>
    <ul id="weibo">
        <li>
            
            <!-- åœ¨æ­¤æ’å…¥è·å¾—çš„å¾®åšç§€ä»£ç  -->
            <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=3288975567&verifier=20ffcedd&dpc=1"></iframe>
            
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - iCocos -
<span class="credit">welcome to <a href="http://al1020119.github.io">æ›¹#é»</a></span>
</p>

</footer>
  






<!--
-->



</body>
</html>
