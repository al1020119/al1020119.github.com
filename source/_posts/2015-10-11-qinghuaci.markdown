---
layout: post
title: "爬虫必备-青花瓷抓包"
date: 2015-10-11 09:03:23 +0800
comments: true
categories: 程序员必备
---



在之前个人学习ios开发的时候听过抓包相关的技术，但是自己没有实现，所以也只是当听听。

这段时间，由于公司新项目的原因，但是后台和UI都还没有，而又需要我先开始封装对应的工具或者一下大概的逻辑，我当时就蒙了，最后还是乖乖的来做。

网上找了一些接口，也找了不少类似的网站，但是发现再美我用不了有什么用呢？最后我想到了之前听别人说的网络爬虫，找了不少资料研究了一番。发现效果还不错，就在这里记录下来，希望对你有用！


关于网络数据抓取不仅仅在iOS开发中有，其他开发中也有，也叫网络爬虫，大致分为三种方式实现

* 1: 青花瓷
* 2: 正则表达
* 3: 利用其他语言的工具包：java／Python
 




<!--more-->




charles又名青花瓷，在iOS开发中的抓包中具有重要作用。最大的三点用处，一就是拦截别人软件的发送的请求和后端接口，练习开发。二是自己后端返回的response拦截修改后再接收以达到测试临界数据的作用。三写脚本重复拦截抓取别人的数据。(因为不太道德，本文不提第三点)

如果你不是在董铂然博客园看到本文，请点击查看原文。

###1.开始之前的准备工作

首先安装一下这个软件

这个相信很多人电脑里应该都安装了，没安装的搜charles破解版也能很容易搜到。如果没安装java环境，首次进入charles会提示让你安装java包得，直接给你链接是苹果官网的，去下一个一键安装就行了。

 {% img /images/qinghuaci001.jpg Caption %}  


安装完成后先打开，在进行下面操作。

 

然后去自己电脑的系统偏好设置-》网络-》选中现在连着的网(大部分人应该都是WiFi吧)可以查到自己这个电脑在现在这个wifi里的IP地址，比如我现在这个就是192.168.0.105(建议最好用私人网络，用公司网络的话可能会有限制会出现没反应的问题)

 
{% img /images/qinghuaci002.jpg Caption %}  

 

然后找到自己手机也连着这个同名的wifi，然后选中右边的蓝色i。

 {% img /images/qinghuaci003.jpg Caption %}  

{% img /images/qinghuaci004.jpg Caption %}  

 

然后进入到了这个无线局域网的高级设置页面。进去之后拉到最下方，找到HTTP代理字样。然后选中手动代理，并在服务器中填自己电脑查到的ip地址，然后把端口调8888，最后点击左上角返回。返回值后系统会自动设置代理重新连接。

这时候你的手机上网的过程中就要经过你的电脑了。刚用手机打开一个联网的程序，你的电脑上应该会显示一个弹窗问你【allow】还是【deny】肯定不能拒绝啊就点allow吧。这个只有第一次才弹窗，图没截上，你到时候看见肯定能看懂的。点了同意之后你手机发出的每一个请求都会被拦截出痕迹。

###2.拦截某个软件的接口数据

拿网易新闻举例，以前就练习这写过网易新闻的项目，其中网易的接口全是用charles拦截的。拦截到了网易发请求时发的是什么，然后在练习项目中需要获取数据的地方也把这一串链接直接拿过来用即可。

 
{% img /images/qinghuaci005.jpg Caption %}  

 

当然这上面拦到的比较多，如果有过开发经验的话应该能很快看出来右边哪个是真正返回json数据的接口。或者一个一个点看内容也行啊。

比如选中一个url然后右键点击copy。

 

{% img /images/qinghuaci006.jpg Caption %}  
 

放到浏览器地址栏里打一下。能看到

 
{% img /images/qinghuaci007.jpg Caption %}  

 

这就说明这个接口是对的了。可以获取到数据。然后可以给他转化一下看的更清楚。虽然很多人都是用bash看，但我还是推荐一个网址[http://www.w3cschool.cc/jsontool](http://www.w3cschool.cc/jsontool)。转JSON之后看的非常清晰。大部分软件json整理后都是默认把大括号全都打开，而仅有这个网站是默认全给你把大括号关上。想点哪个再点开，而且能知道字典里有多少个键值对，所以看着非常清晰。

 

{% img /images/qinghuaci008.jpg Caption %}  
 

到此就已经完成了一次完整的，拉取接口，和获得数据。

这里有两点我想说下：

①就是如果这个App发的请求加密了或是RSA什么的，这个就算拦截了你也弄不到数据。网易是没有做任何加密，所以可以抓取到数据。以前试了拦截百度医生的就不行。他设置的是一分钟内能获取到数据，超过了1分钟这个复制过来的接口就取不到数据了。怀疑可能是用的HMAC方法加密，并且在里面加入了时间判断。32分和33分发出的请求经过编码后是不一样的，后台可能做了容错，会把32分和31分都和你判断下，只要有一个对上就让你过，但是超过了整整一分钟后是肯定获取不到数据了。

②就是很多比较大型的网站，一般会开放一个开发者平台，里面注册开发者账号后会向你公开一个接口文档，你不用再去费事的拦截了。像新浪微博和大众点评都有开发者平台。

###3.更改返回数据来测试临界情况

这个是重点了。因为这种做法可以让一个iOS前端的开发人员独立完成测试而不用拉过来一个后端一起联调。并且各种特殊维度，或是临界的账号也不用再去辛苦找了，仅仅自己在青花瓷上改来改去就可以达到效果了。比如这个地方如果返回了nil程序会不会崩，直接改response就行了。下面是具体操作方案。

打开青花瓷切换成结构页面

 
{% img /images/qinghuaci009.jpg Caption %}  

 

这里可以看到断点和调试信息

 
{% img /images/qinghuaci010.jpg Caption %}  
{% img /images/qinghuaci011.jpg Caption %}  

 

然后找一个我们公司的页面。这个页面本来应该返回是这样的：如上图右边

你先正常的打开这个页面把玩几下，这个青花瓷就会抓取很多接口和域名分类了。在这里找到你这个页面所属的域名分类应该不难。然后打上断点。这里要注意是在域名上打断点而不是在下面的单个请求上打断点。

再次用手机进入这个页面，就会通过你刚才打断点的那个域名来请求数据，就会被断点拦住，如下图所示。

 
{% img /images/qinghuaci012.jpg Caption %}  

 

右边的信息也很清晰，一开始可以编辑请求。如果点击单步执行，等一下相应回来了也可以编辑响应。

 

{% img /images/qinghuaci013.jpg Caption %}  
 
{% img /images/qinghuaci014.jpg Caption %}  
 


这里的有好几种查看的方式，但是推荐使用JSON Text看的比较清楚。 现在我们对拦截回来的数据进行修改，我把这些统计数据全改成999如下图

 

 {% img /images/qinghuaci015.jpg Caption %}  


 

然后再次点击下方的Execute单步执行，更改后的数据就会像正常返回回来的数据那样显示到，APP的页面上展示。

 
{% img /images/qinghuaci016.jpg Caption %}  

 

能来到这一步就说明已经完整的掌握了用青花瓷篡改返回数据测试App的技术。

如果你不是在董铂然博客园看到本文，请点击查看原文。

这么做的意义：

这里只是简单的更改了一些数字，在页面显示更加直观。实际的操作中，你可以经常用来把某些值改为临界情况以看到App在处理这些临界状况时的反应，这样比找那些临界数据的测试账号成本要低得多。也可以把一些可能不会反回数值的字段找到，直接将里面的值删成nil，看看会不会报异常等等。